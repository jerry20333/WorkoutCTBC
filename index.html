<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fitness Pro v4.0</title>
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZpdG5lc3MgUHJvIHY0LjAiLAogICJzaG9ydF9uYW1lIjogIkZpdFBybyIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjMjU2M2ViIiwKICAiaWNvbnMiOiBbXQp9">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Light Theme */
            --bg-color: #f3f6f9;
            --card-bg: #ffffff;
            --primary: #2563eb;
            --primary-soft: #eff6ff;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --input-bg: #f8fafc;
            --border-radius: 24px;
            --btn-radius: 50px;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            --danger: #ff4757;
            --success: #2ed573;
            --nav-height: 70px;
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary: #3b82f6;
            --primary-soft: #2c2c2c;
            --text-main: #f1f5f9;
            --text-sub: #a0a0a0;
            --input-bg: #2c2c2c;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding-bottom: calc(var(--nav-height) + 30px);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 600px; margin: 0 auto; min-height: 100vh; position: relative; padding: 20px;
        }

        /* Loading Spinner */
        #loading-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--primary-soft);
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Typography & Layout */
        h1, h2, h3 { margin: 0 0 12px 0; font-weight: 800; letter-spacing: -0.5px; }
        p { margin: 0 0 12px 0; color: var(--text-sub); line-height: 1.6; font-size: 0.95rem; }
        
        .section { display: none; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Card UI */
        .card {
            background: var(--card-bg); 
            border-radius: var(--border-radius); 
            padding: 24px;
            margin-bottom: 20px; 
            box-shadow: var(--shadow);
            border: none;
            position: relative;
            transition: transform 0.2s ease;
        }
        .card.completed { opacity: 0.6; filter: grayscale(0.8); }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }

        /* Buttons */
        .btn {
            display: flex; align-items: center; justify-content: center;
            width: 100%; padding: 16px; border-radius: var(--btn-radius);
            background-color: var(--primary); color: #fff;
            font-weight: 700; font-size: 1rem; border: none; cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            transition: transform 0.1s, opacity 0.2s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); box-shadow: none; }
        .btn-success { background-color: var(--success); box-shadow: 0 4px 12px rgba(46, 213, 115, 0.3); }
        .btn-danger { background-color: var(--danger); box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3); }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; width: auto; display: inline-flex; border-radius: 20px; }

        /* Inputs */
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; color: var(--text-sub); font-size: 0.9rem; font-weight: 600; padding-left: 5px; }
        input, select {
            width: 100%; padding: 14px 16px; border-radius: 16px;
            border: 1px solid transparent; background: var(--input-bg);
            color: var(--text-main); font-size: 1rem;
            appearance: none; transition: all 0.2s;
        }
        input:focus, select:focus { background: var(--card-bg); border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-soft); }

        /* Workout Specific */
        .workout-row { display: grid; grid-template-columns: 1.5fr 1fr 1.5fr; gap: 12px; margin-top: 20px; }
        .w-input { text-align: center; font-weight: 800; color: var(--primary); font-size: 1.1rem; }
        .timer-display {
            font-family: 'Courier New', monospace; font-size: 2.2rem; font-weight: 800;
            text-align: center; color: var(--text-main); margin: 20px 0; letter-spacing: 2px;
        }
        .muscle-badge {
            background: var(--primary-soft); color: var(--primary);
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700;
        }

        /* Checkbox List (Locked) */
        .checkbox-item {
            display: flex; align-items: center; padding: 12px;
            background: var(--input-bg); border-radius: 16px; margin-bottom: 8px; opacity: 0.7;
        }
        .checkbox-item input { width: 20px; height: 20px; margin-right: 12px; box-shadow: none; }

        /* Modals */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(8px); display: none;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal.show { opacity: 1; }
        .modal-content {
            background: var(--card-bg); width: 90%; max-width: 420px; max-height: 85vh;
            padding: 30px; border-radius: 30px; overflow-y: auto;
            position: relative; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        @keyframes popIn { from { transform: scale(0.9) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        /* Feedback Emoji */
        .feedback-options { display: flex; justify-content: space-between; margin-top: 20px; }
        .fb-option { 
            text-align: center; cursor: pointer; padding: 10px; border-radius: 16px; 
            background: var(--input-bg); flex: 1; margin: 0 5px; transition: 0.2s;
            border: 2px solid transparent;
        }
        .fb-option.selected { border-color: var(--primary); background: var(--primary-soft); }
        .fb-emoji { font-size: 2rem; display: block; margin-bottom: 5px; }

        /* Rest Timer */
        #rest-timer-display { font-size: 4.5rem; font-weight: 900; color: #fff; text-align: center; margin: 30px 0; font-family: monospace; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        /* Navigation */
        .nav-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: var(--nav-height);
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(15px); border-radius: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex; justify-content: space-around; align-items: center; z-index: 500;
            padding: 0 10px;
        }
        [data-theme="dark"] .nav-bar { background: rgba(30, 30, 30, 0.9); }
        
        .nav-item { 
            color: var(--text-sub); text-align: center; flex: 1; 
            padding: 10px 0; cursor: pointer; border-radius: 50%; height: 60px; width: 60px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }
        .nav-item i { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-item span { font-size: 0.7rem; font-weight: 600; }

        /* Steps */
        .step-list { list-style: none; padding: 0; margin: 15px 0; }
        .step-list li { margin-bottom: 15px; position: relative; padding-left: 30px; }
        .step-list li::before { content: "â€¢"; color: var(--primary); font-size: 2rem; position: absolute; left: 0; top: -8px; }
        .mistake-list { list-style: none; padding: 0; }
        .mistake-list li { color: var(--danger); margin-bottom: 8px; padding-left: 20px; position: relative; }
        .mistake-list li::before { content: "Ã—"; position: absolute; left: 0; font-weight: bold; }
    </style>
</head>
<body>

<div id="loading-overlay"><div class="spinner"></div></div>

<div class="app-container">

    <div id="onboarding-page" class="section">
        <h1>å»ºç«‹æ‚¨çš„æª”æ¡ˆ</h1>
        <p>Fitness Pro v4.0 - è«‹è¼¸å…¥è©³ç´°èº«é«”æ•¸å€¼ä»¥ä¾› AI é‹ç®—</p>
        
        <div class="card">
            <div class="form-group">
                <label>æ‚¨çš„ç¨±å‘¼</label>
                <input type="text" id="ob-name" placeholder="Name" value="å¥å‹">
            </div>
            
            <div class="stats-grid">
                <div class="form-group">
                    <label>èº«é«˜ (cm)</label>
                    <input type="number" id="ob-height" placeholder="175">
                </div>
                <div class="form-group">
                    <label>é«”é‡ (kg)</label>
                    <input type="number" id="ob-weight" placeholder="70">
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="form-group">
                    <label>å¹´é½¡</label>
                    <input type="number" id="ob-age" placeholder="25">
                </div>
                <div class="form-group">
                    <label>é«”è„‚ç‡ (%)</label>
                    <input type="number" id="ob-fat" placeholder="20">
                </div>
            </div>

            <div class="stats-grid">
                <div class="form-group">
                    <label>åŸºç¤ä»£è¬ BMR</label>
                    <input type="number" id="ob-bmr" placeholder="1600">
                </div>
                <div class="form-group">
                    <label>éª¨éª¼è‚Œé‡ (kg)</label>
                    <input type="number" id="ob-muscle" placeholder="32">
                </div>
            </div>

            <div class="form-group">
                <label>è¨“ç·´ç›®æ¨™</label>
                <select id="ob-goal">
                    <option value="muscle">å¢è‚Œ (Hypertrophy)</option>
                    <option value="fat_loss">æ¸›è„‚ (Fat Loss)</option>
                    <option value="strength">åŠ›é‡ (Strength)</option>
                </select>
            </div>
        </div>

        <div class="card">
            <h3>å™¨æç¢ºèª</h3>
            <p style="font-size:0.85rem;">å·²é–å®šæ‚¨æŒ‡å®šçš„å™¨ææ¸…å–®</p>
            <div id="ob-equipment"></div>
        </div>
        
        <button class="btn" onclick="app.completeOnboarding()">é–‹å§‹è¨“ç·´æ—…ç¨‹</button>
    </div>

    <div id="home-page" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div>
                <h2 id="home-greeting" style="margin-bottom:0;">Hi</h2>
                <span style="font-size:0.85rem; color:var(--text-sub);" id="week-date">--/--</span>
            </div>
            <button class="btn-sm btn-outline" onclick="app.toggleTheme()" style="border-radius:50%; width:40px; height:40px; padding:0; display:flex; align-items:center; justify-content:center;">
                <i class="fa-solid fa-moon"></i>
            </button>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-weight:700; color:var(--text-sub);">æœ¬é€±ç›®æ¨™</span>
                <span id="week-prog-text" style="color:var(--primary); font-weight:800;">0/3</span>
            </div>
            <div style="height:12px; background:var(--input-bg); border-radius:10px; overflow:hidden;">
                <div id="home-prog-bar" style="height:100%; background:var(--primary); width:0%; border-radius:10px; transition:width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);"></div>
            </div>
        </div>

        <div class="card" style="text-align: center; border: 2px dashed var(--primary); background: var(--primary-soft); padding: 40px 20px;">
            <i class="fa-solid fa-dumbbell fa-3x" style="color: var(--primary); margin-bottom: 15px;"></i>
            <h3>ä»Šæ—¥èœå–®</h3>
            <p id="daily-tip" style="font-size:0.9rem;">AI å·²ä¾æ“šæ‚¨çš„é«”è³ªèˆ‡ä¸Šé€±å›é¥‹èª¿æ•´å¼·åº¦</p>
            <button class="btn" style="margin-top:15px; width:80%; margin-left:auto; margin-right:auto;" onclick="app.generateWorkout()">ç”¢ç”Ÿè¨“ç·´</button>
        </div>

        <div class="card">
            <h3><i class="fa-solid fa-clock-rotate-left"></i> ä¸Šæ¬¡ç´€éŒ„</h3>
            <div id="last-summary"><p>å°šç„¡ç´€éŒ„ã€‚</p></div>
        </div>
    </div>

    <div id="workout-page" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 id="wo-title">è¨“ç·´ä¸­</h2>
            <button class="btn-sm btn-danger" onclick="app.quitWorkout()">æ”¾æ£„</button>
        </div>
        <div id="workout-list"></div>
        <button class="btn btn-success" style="margin-top:30px;" onclick="app.finishAll()">çµæŸä¸¦å„²å­˜</button>
        <div style="height: 80px;"></div>
    </div>

    <div id="progress-page" class="section">
        <h2>æ•¸æ“šä¸­å¿ƒ</h2>
        
        <div class="card">
            <h3>è¨“ç·´é »ç‡ (é€±)</h3>
            <div style="height:200px">
                <canvas id="freqChart"></canvas>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>æ­·å²ç´€éŒ„</h3>
                <button class="btn-sm btn-outline" onclick="app.exportCSV()">
                    <i class="fa-solid fa-download"></i> CSV
                </button>
            </div>
            <div style="margin-bottom:15px;">
                <select id="history-filter" onchange="app.renderHistory()">
                    <option value="all">æ‰€æœ‰å‹•ä½œ</option>
                    <option value="chest">èƒ¸éƒ¨</option>
                    <option value="back">èƒŒéƒ¨</option>
                    <option value="shoulders">è‚©éƒ¨</option>
                    <option value="legs">è…¿éƒ¨</option>
                    <option value="core">æ ¸å¿ƒ</option>
                </select>
            </div>
            <div id="history-list"></div>
        </div>
        
        <div class="card">
            <h3>è³‡æ–™ç®¡ç†</h3>
            <button class="btn btn-danger" onclick="app.resetData()">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
            <p id="storage-usage" style="font-size:0.8rem; text-align:center; margin-top:10px;">0 KB</p>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="app.nav('home-page')">
            <i class="fa-solid fa-house"></i>
            <span>é¦–é </span>
        </div>
        <div class="nav-item" onclick="app.nav('progress-page')">
            <i class="fa-solid fa-chart-line"></i>
            <span>æ•¸æ“š</span>
        </div>
    </div>

</div>

<div id="rest-modal" class="modal">
    <div class="modal-content" style="text-align:center; background: #222; color: #fff;">
        <h2 style="color:#aaa; font-size:1.2rem;">ä¼‘æ¯ä¸€ä¸‹</h2>
        <div id="rest-timer-display">01:30</div>
        <div style="display:flex; gap:15px; justify-content:center;">
            <button class="btn btn-outline" style="border-color:#555; color:#aaa; width:auto; border-radius:30px;" onclick="app.addRestTime(30)">+30s</button>
            <button class="btn btn-danger" style="width:auto; border-radius:30px;" onclick="app.skipRest()">è·³é</button>
        </div>
    </div>
</div>

<div id="instruction-modal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 id="inst-title" style="margin:0; color:var(--primary);">å‹•ä½œåç¨±</h2>
            <button style="background:none; border:none; font-size:2rem; color:var(--text-sub);" onclick="app.closeModal('instruction-modal')">&times;</button>
        </div>
        <div id="inst-content" style="line-height:1.8;"></div>
        <button class="btn" style="margin-top:25px;" onclick="app.closeModal('instruction-modal')">æˆ‘æ‡‚äº†</button>
    </div>
</div>

<div id="feedback-modal" class="modal">
    <div class="modal-content">
        <h3>é€±å›é¡§</h3>
        <p>ä¸Šé€±çš„è¨“ç·´æ„Ÿå—å¦‚ä½•ï¼Ÿæˆ‘å€‘å°‡ä¾æ­¤èª¿æ•´ä¸‹é€±èœå–®ã€‚</p>
        <div class="feedback-options">
            <div class="fb-option" onclick="app.selectFeedback('easy', this)">
                <span class="fb-emoji">ğŸ˜</span>
                å¤ªè¼•é¬†
            </div>
            <div class="fb-option selected" onclick="app.selectFeedback('ok', this)">
                <span class="fb-emoji">ğŸ™‚</span>
                å‰›å¥½
            </div>
            <div class="fb-option" onclick="app.selectFeedback('hard', this)">
                <span class="fb-emoji">ğŸ¥µ</span>
                å¤ªç´¯äº†
            </div>
        </div>
        <button class="btn" style="margin-top:25px;" onclick="app.submitFeedback()">æäº¤ä¸¦æ›´æ–°</button>
    </div>
</div>

<script>
/**
 * Fitness Pro v4.0 - Personalized Logic
 */

// --- Audio ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playBeep() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.6);
    osc.stop(audioCtx.currentTime + 0.6);
    if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
}

// --- Equipment List (Locked) ---
const EQUIPMENTS = [
    {id:'roman_chair', name:'ç¾…é¦¬æ¤…'},
    {id:'shoulder_press_machine', name:'è‚©éƒ¨æ¨èˆ‰è¨“ç·´æ©Ÿ'},
    {id:'chest_press_machine', name:'èƒ¸éƒ¨æ¨èˆ‰è¨“ç·´æ©Ÿ'},
    {id:'dumbbell', name:'å•éˆ´'},
    {id:'treadmill', name:'è·‘æ­¥æ©Ÿ'},
    {id:'fly_machine', name:'èƒ¸éƒ¨/è‚©éƒ¨é£›é³¥è¨“ç·´æ©Ÿ'},
    {id:'leg_curl_machine', name:'è…¿éƒ¨å½æ›²è¨“ç·´æ©Ÿ'},
    {id:'seated_row', name:'åå§¿åˆ’èˆ¹'},
    {id:'lat_pulldown', name:'åå§¿æ»‘è¼ªä¸‹æ‹‰'},
    {id:'situp_bench', name:'ä»°è‡¥èµ·åæ¿'}
];

// --- Exercise DB ---
const EXERCISE_DB = {
    // Chest
    chest_press: { 
        name:'åå§¿èƒ¸æ¨', muscle:'èƒ¸éƒ¨', type:'push', equip:'chest_press_machine', 
        steps:['èª¿æ•´æ¤…å¢Šé«˜åº¦ï¼Œä½¿æ¡æŠŠå°æº–èƒ¸ç·š', 'æŒºèƒ¸æ”¶è…¹ï¼ŒèƒŒéƒ¨ç·Šè²¼æ¤…èƒŒ', 'åæ°£æ™‚å‘å‰æ¨ï¼Œå¸æ°£ç·©æ…¢é‚„åŸ'], 
        mistakes:['è³è‚©', 'æ‰‹è‚˜é–æ­»', 'è…°éƒ¨éåº¦æ‹±èµ·'] 
    },
    pec_fly: { 
        name:'åå§¿å¤¾èƒ¸', muscle:'èƒ¸éƒ¨', type:'push', equip:'fly_machine', 
        steps:['èª¿æ•´æ¡æŠŠä½ç½®ï¼Œä½¿æ‰‹è‡‚å¾®å½ä¸”æ‰‹è‚˜èˆ‡è‚©åŒé«˜', 'åˆ©ç”¨èƒ¸è‚ŒåŠ›é‡å°‡æ¡æŠŠå‘ä¸­é–“å¤¾', 'é›¢å¿ƒéšæ®µæ§åˆ¶é€Ÿåº¦'], 
        mistakes:['æ‰‹è‚˜æ‰“å¤ªç›´', 'åˆ©ç”¨èº«é«”æ™ƒå‹•å€ŸåŠ›'] 
    },
    db_bench_press: { 
        name:'å•éˆ´è‡¥æ¨', muscle:'èƒ¸éƒ¨', type:'push', equip:'dumbbell', 
        steps:['èººåœ¨ä»°è‡¥æ¿ä¸Š(æˆ–ä½¿ç”¨ä»°è‡¥èµ·åæ¿æ”¾å¹³)', 'é›™æ‰‹æŒå•éˆ´ç½®æ–¼èƒ¸å´', 'å‚ç›´å‘ä¸Šæ¨èˆ‰ï¼Œä¿æŒæ‰‹è…•ä¸­ç«‹'], 
        mistakes:['æ‰‹è…•å½æ›²', 'å•éˆ´ç¢°æ’'] 
    },
    // Shoulders
    shoulder_press: { 
        name:'æ©Ÿå™¨è‚©æ¨', muscle:'è‚©éƒ¨', type:'push', equip:'shoulder_press_machine', 
        steps:['æ¡ä½æŠŠæ‰‹ï¼Œæ‰‹æŒæœå‰', 'å‘ä¸Šæ¨èˆ‰è‡³æ‰‹è‡‚ä¼¸ç›´ä½†é—œç¯€ä¸é–æ­»', 'ç·©æ…¢ä¸‹æ”¾è‡³è€³æœµé«˜åº¦'], 
        mistakes:['ä¸‹èƒŒé›¢é–‹æ¤…èƒŒ', 'æ¨èˆ‰éå¿«'] 
    },
    reverse_fly: { 
        name:'åå‘é£›é³¥', muscle:'è‚©éƒ¨', type:'pull', equip:'fly_machine', 
        steps:['é¢å°æ¤…èƒŒå(åå‘ä½¿ç”¨é£›é³¥æ©Ÿ)', 'é›™æ‰‹æ¡æŠŠå‘å¾Œæ‹‰é–‹', 'æ„Ÿå—å¾Œä¸‰è§’è‚Œæ”¶ç¸®'], 
        mistakes:['è³è‚©', 'æ‰‹è‚˜éä½'] 
    },
    db_lateral_raise: { 
        name:'å•éˆ´å´å¹³èˆ‰', muscle:'è‚©éƒ¨', type:'push', equip:'dumbbell', 
        steps:['ç«™å§¿ï¼Œé›™æ‰‹æŒå•éˆ´', 'æ‰‹è‚˜å¾®å½ï¼Œå‘å…©å´å¹³èˆ‰è‡³è‚©è†€é«˜åº¦', 'åƒå€’æ°´ä¸€æ¨£å°æŒ‡ç•¥é«˜'], 
        mistakes:['åˆ©ç”¨èº«é«”ç”©å‹•', 'èˆ‰å¤ªé«˜é€ æˆå¤¾æ“ '] 
    },
    // Back
    lat_pulldown: { 
        name:'æ»‘è¼ªä¸‹æ‹‰', muscle:'èƒŒéƒ¨', type:'pull', equip:'lat_pulldown', 
        steps:['å¯¬æ¡æ¡æŠŠï¼Œå¤§è…¿å¡ç·Š', 'å°‡æ¡æŠŠæ‹‰è‡³ä¸Šèƒ¸ä½ç½®', 'æŒºèƒ¸ä¸é§èƒŒ'], 
        mistakes:['éåº¦å¾Œä»°', 'æ‹‰è‡³é ¸å¾Œ'] 
    },
    seated_row: { 
        name:'åå§¿åˆ’èˆ¹', muscle:'èƒŒéƒ¨', type:'pull', equip:'seated_row', 
        steps:['é›™è…³è¸©ç©©ï¼Œä¿æŒè†è“‹å¾®å½', 'èƒŒéƒ¨æŒºç›´ï¼Œå°‡æ¡æŠŠæ‹‰å‘è…¹éƒ¨', 'æ„Ÿå—è‚©èƒ›éª¨å¤¾ç·Š'], 
        mistakes:['åœ“èƒŒ', 'åˆ©ç”¨è…°éƒ¨å‰å¾Œæ–æ™ƒ'] 
    },
    db_row: { 
        name:'å–®è‡‚åˆ’èˆ¹', muscle:'èƒŒéƒ¨', type:'pull', equip:'dumbbell', 
        steps:['ä¸€æ‰‹æ”¯æ’(å¯ä½¿ç”¨ç¾…é¦¬æ¤…æ‰¶æ‰‹æˆ–ä»°è‡¥æ¿)', 'å¦ä¸€æ‰‹æŒå•éˆ´æ‹‰å‘è…°éš›', 'èƒŒéƒ¨ä¿æŒæ°´å¹³'], 
        mistakes:['èº«é«”æ—‹è½‰', 'åªç”¨æ‰‹è‡‚åŠ›é‡'] 
    },
    // Legs
    leg_curl: { 
        name:'åå§¿/è¶´å§¿è…¿å‹¾', muscle:'è…¿éƒ¨', type:'legs', equip:'leg_curl_machine', 
        steps:['èª¿æ•´é å¢Šä½ç½®è‡³è…³è¸ä¸Šæ–¹', 'åˆ©ç”¨å¤§è…¿å¾Œå´åŠ›é‡å‹¾èµ·é‡é‡', 'ç·©æ…¢é‚„åŸ'], 
        mistakes:['è‡€éƒ¨é›¢é–‹æ¤…å¢Š', 'å‹•ä½œéå¿«'] 
    },
    goblet_squat: { 
        name:'é«˜å¸ƒé›·æ·±è¹²', muscle:'è…¿éƒ¨', type:'legs', equip:'dumbbell', 
        steps:['é›™æ‰‹æ§ä½ä¸€é¡†å•éˆ´æ–¼èƒ¸å‰', 'é›™è…³èˆ‡è‚©åŒå¯¬ï¼Œå±è‚¡å‘å¾Œå', 'è†è“‹å°æº–è…³å°–æ–¹å‘'], 
        mistakes:['è†è“‹å…§å¤¾', 'å½è…°'] 
    },
    db_lunge: { 
        name:'å•éˆ´å¼“ç®­æ­¥', muscle:'è…¿éƒ¨', type:'legs', equip:'dumbbell', 
        steps:['é›™æ‰‹æŒå•éˆ´å‚æ–¼é«”å´', 'å‘å‰è·¨ä¸€å¤§æ­¥ä¸‹è¹²', 'å¾Œè…³è†è“‹æ¥è¿‘åœ°é¢'], 
        mistakes:['è†è“‹è¶…éè…³å°–éå¤š', 'èº«é«”å‰å‚¾'] 
    },
    treadmill_warmup: { 
        name:'è·‘æ­¥æ©Ÿç†±èº«', muscle:'è…¿éƒ¨', type:'cardio', equip:'treadmill', 
        steps:['è¨­å®šå¡åº¦ 1-2%', 'é€Ÿåº¦ 5-7 km/h', 'å¿«èµ° 5-10 åˆ†é˜'], 
        mistakes:['æ‰‹æŠ“æ‰¶æ‰‹ä¸æ”¾', 'æ­¥ä¼éå¤§'] 
    },
    // Core
    sit_up: { 
        name:'ä»°è‡¥èµ·å', muscle:'æ ¸å¿ƒ', type:'core', equip:'situp_bench', 
        steps:['èººåœ¨ä»°è‡¥æ¿ä¸Šï¼Œè…³å‹¾ä½å›ºå®šå™¨', 'é›™æ‰‹ç½®æ–¼è€³å´æˆ–èƒ¸å‰', 'åˆ©ç”¨è…¹éƒ¨åŠ›é‡æ²èµ·ä¸ŠåŠèº«'], 
        mistakes:['é›™æ‰‹æŠ±é ­ç¡¬æ‹‰é ¸éƒ¨', 'åˆ©ç”¨æ…£æ€§ç”©å‹•'] 
    },
    back_extension: { 
        name:'ç¾…é¦¬æ¤…èƒŒä¼¸', muscle:'æ ¸å¿ƒ', type:'core', equip:'roman_chair', 
        steps:['é å¢Šèª¿æ•´è‡³é«–éª¨ä¸‹æ–¹', 'èƒŒéƒ¨æŒºç›´ä¸‹å½', 'åˆ©ç”¨ä¸‹èƒŒèˆ‡è‡€éƒ¨åŠ›é‡æŒºèµ·è‡³èº«é«”å‘ˆç›´ç·š'], 
        mistakes:['éåº¦å¾Œä»°', 'å‹•ä½œå¤ªå¿«'] 
    }
};

// --- App Logic ---
const app = {
    data: { 
        profile: null, 
        history: [], 
        currentWorkout: [], 
        timers: {}, 
        restInterval: null, 
        restTimeLeft: 0,
        tempFeedback: 'ok' 
    },

    init: async function() {
        setTimeout(() => document.getElementById('loading-overlay').style.opacity = '0', 500);
        setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 1000);

        if(localStorage.getItem('fp_theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
        
        // Show Locked Equipment
        const eqDiv = document.getElementById('ob-equipment');
        eqDiv.innerHTML = EQUIPMENTS.map(e => `
            <label class="checkbox-item">
                <input type="checkbox" value="${e.id}" checked disabled>
                <span style="font-size:0.95rem;">${e.name}</span>
            </label>
        `).join('');

        const p = localStorage.getItem('fp_profile');
        const h = localStorage.getItem('fp_history');
        if(h) this.data.history = JSON.parse(h);

        if(!p) {
            this.nav('onboarding-page');
        } else {
            this.data.profile = JSON.parse(p);
            this.renderHome();
            this.nav('home-page');
            this.checkWeeklyFeedback();
        }
    },

    nav: function(pageId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        window.scrollTo(0,0);
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(pageId === 'home-page') document.querySelectorAll('.nav-item')[0].classList.add('active');
        if(pageId === 'progress-page') {
            document.querySelectorAll('.nav-item')[1].classList.add('active');
            this.renderProgress();
        }
        
        const nav = document.querySelector('.nav-bar');
        if(pageId === 'onboarding-page' || pageId === 'workout-page') nav.style.display = 'none';
        else nav.style.display = 'flex';
    },

    toggleTheme: function() {
        if(document.body.getAttribute('data-theme') === 'dark') {
            document.body.removeAttribute('data-theme');
            localStorage.setItem('fp_theme', 'light');
        } else {
            document.body.setAttribute('data-theme', 'dark');
            localStorage.setItem('fp_theme', 'dark');
        }
    },

    // --- 1. Enhanced Onboarding ---
    completeOnboarding: function() {
        const els = id => document.getElementById(id).value;
        const name = els('ob-name') || 'å¥å‹';
        const height = Number(els('ob-height'));
        const weight = Number(els('ob-weight'));
        const age = Number(els('ob-age'));
        const fat = Number(els('ob-fat'));
        const bmr = Number(els('ob-bmr'));
        const muscle = Number(els('ob-muscle'));
        const goal = els('ob-goal');

        if(!height || !weight || !age || !bmr) return alert('è«‹å®Œæ•´å¡«å¯«èº«é«”æ•¸å€¼ï¼Œä»¥ä¾¿æˆ‘å€‘å®¢è£½åŒ–èœå–®ã€‚');

        const p = {
            name, height, weight, age, fat, bmr, muscle, goal,
            equip: EQUIPMENTS.map(e => e.id),
            created: new Date().toISOString(),
            lastFeedbackDate: new Date().toISOString(),
            weeklyFeel: 'ok' // default
        };
        this.data.profile = p;
        localStorage.setItem('fp_profile', JSON.stringify(p));
        this.renderHome();
        this.nav('home-page');
    },

    // --- 2. Weekly Feedback Logic ---
    checkWeeklyFeedback: function() {
        const p = this.data.profile;
        if(!p.lastFeedbackDate) return;
        
        const last = new Date(p.lastFeedbackDate);
        const now = new Date();
        const diffDays = Math.floor((now - last) / (1000 * 60 * 60 * 24));

        if(diffDays >= 7) {
            const m = document.getElementById('feedback-modal');
            m.classList.add('show');
            m.style.display = 'flex';
        }
    },

    selectFeedback: function(val, el) {
        this.data.tempFeedback = val;
        document.querySelectorAll('.fb-option').forEach(d => d.classList.remove('selected'));
        el.classList.add('selected');
    },

    submitFeedback: function() {
        this.data.profile.weeklyFeel = this.data.tempFeedback;
        this.data.profile.lastFeedbackDate = new Date().toISOString();
        localStorage.setItem('fp_profile', JSON.stringify(this.data.profile));
        this.closeModal('feedback-modal');
        alert('æ„Ÿè¬å›é¥‹ï¼ä¸‹é€±è¨“ç·´èœå–®å·²è‡ªå‹•èª¿æ•´ã€‚');
    },

    // --- Home ---
    renderHome: function() {
        const p = this.data.profile;
        document.getElementById('home-greeting').textContent = `Hi, ${p.name}`;
        
        const curr = new Date();
        const first = curr.getDate() - curr.getDay() + 1;
        const d1 = new Date(curr.setDate(first)).toLocaleDateString().slice(5);
        const d2 = new Date(curr.setDate(first + 6)).toLocaleDateString().slice(5);
        document.getElementById('week-date').textContent = `${d1} - ${d2}`;

        // Progress
        const startOfWeek = new Date();
        startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
        startOfWeek.setHours(0,0,0,0);
        const count = this.data.history.filter(h => new Date(h.date) >= startOfWeek).length;
        const target = 3; 
        document.getElementById('week-prog-text').textContent = `${count}/${target}`;
        document.getElementById('home-prog-bar').style.width = `${Math.min((count/target)*100, 100)}%`;

        // Update Daily Tip based on Feedback
        const tipEl = document.getElementById('daily-tip');
        if(p.weeklyFeel === 'hard') tipEl.textContent = 'æª¢æ¸¬åˆ°ä¸Šé€±è¼ƒç–²å‹ï¼Œä»Šæ—¥å°‡è‡ªå‹•é™ä½è¨“ç·´é‡ã€‚';
        else if(p.weeklyFeel === 'easy') tipEl.textContent = 'ç‹€æ…‹çµ•ä½³ï¼ä»Šæ—¥å°‡ç•¥å¾®å¢åŠ è¨“ç·´å¼·åº¦ã€‚';
        else tipEl.textContent = 'AI æ­£æ ¹æ“šæ‚¨çš„èº«é«”æ•¸æ“šè¦åŠƒä»Šæ—¥è² è·...';

        if(this.data.history.length > 0) {
            const last = this.data.history[this.data.history.length-1];
            document.getElementById('last-summary').innerHTML = `
                <div style="font-weight:700; margin-bottom:5px;">${new Date(last.date).toLocaleDateString()}</div>
                <div style="color:var(--text-sub); font-size:0.9rem;">${last.exercises.length} å‹•ä½œãƒ»${Math.round(last.duration/60)} åˆ†é˜ãƒ»RPE ${last.avgRpe}</div>
            `;
        }
    },

    // --- 3. Adaptive Workout Generation ---
    generateWorkout: function() {
        const { goal, weight, weeklyFeel, muscle } = this.data.profile;
        
        let selected = [EXERCISE_DB.treadmill_warmup];
        const pick = type => {
            const list = Object.values(EXERCISE_DB).filter(e => e.type === type && e.id !== 'treadmill_warmup');
            return list[Math.floor(Math.random() * list.length)];
        };
        selected.push(pick('push'), pick('pull'), pick('legs'), pick('core'));

        this.data.currentWorkout = selected.map((move, i) => {
            const historyList = [...this.data.history].reverse();
            let lastRecord = null;
            for(let h of historyList) {
                const found = h.exercises.find(e => e.name === move.name);
                if(found) { lastRecord = found; break; }
            }

            // A. Base Reps/Sets based on Goal & Feedback
            let sets = 3;
            let reps = 12;

            // Feedback adjustment
            if(weeklyFeel === 'hard') sets = 2;
            if(weeklyFeel === 'easy') sets = 4;

            // Goal adjustment
            if(goal === 'strength') reps = 6;
            if(goal === 'fat_loss') reps = 15;

            // Cardio exception
            let load = 0;
            if(move.type === 'cardio') { sets=1; reps='10min'; }
            else if(lastRecord) {
                let w = Number(lastRecord.weight);
                const r = Number(lastRecord.rpe);
                if(r <= 6) w += 2.5; 
                else if(r >= 9) w = Math.max(0, w - 2.5);
                load = w;
                if(move.type !== 'core') reps = lastRecord.reps || reps;
            } else {
                // New Load Calc based on Muscle Mass & Weight
                let ratio = 0.2; // default
                if(goal === 'strength') ratio = 0.3;
                if(muscle < weight * 0.35) ratio -= 0.05; // Low muscle mass safety
                
                load = Math.round(weight * ratio);
                if(move.type === 'core') load = 0;
            }

            const dbKey = Object.keys(EXERCISE_DB).find(key => EXERCISE_DB[key].name === move.name);
            return { ...move, id: dbKey, idx: i, sets, reps, load, timer:0, state:'idle', rpe: 7 };
        });

        this.renderWorkout();
        this.nav('workout-page');
    },

    renderWorkout: function() {
        const div = document.getElementById('workout-list');
        div.innerHTML = '';

        this.data.currentWorkout.forEach(ex => {
            let rpeOpts = '';
            for(let i=1; i<=10; i++) rpeOpts += `<option value="${i}" ${i===7?'selected':''}>${i}</option>`;

            div.innerHTML += `
                <div class="card ${ex.state === 'done' ? 'completed' : ''}" id="card-${ex.idx}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <h3 onclick="app.showInstruction('${ex.id}')" style="cursor:pointer; display:flex; align-items:center;">
                            ${ex.name} <i class="fa-solid fa-circle-info" style="font-size:0.9rem; color:var(--primary); margin-left:8px; opacity:0.7;"></i>
                        </h3>
                        <span class="muscle-badge">${ex.muscle}</span>
                    </div>
                    
                    <div class="workout-row">
                        <div>
                            <label>é‡é‡ (kg)</label>
                            <input type="text" class="w-input" id="w-${ex.idx}" value="${ex.load}" ${ex.type==='cardio'?'disabled':''}>
                        </div>
                        <div>
                            <label>çµ„æ•¸/æ¬¡æ•¸</label>
                            <input type="text" class="w-input" id="s-${ex.idx}" value="${ex.sets} x ${ex.reps}">
                        </div>
                        <div>
                            <label>RPE</label>
                            <select class="w-input" id="rpe-${ex.idx}" style="padding-right:5px;">${rpeOpts}</select>
                        </div>
                    </div>

                    <div class="timer-display" id="t-${ex.idx}">00:00</div>
                    
                    ${ex.state !== 'done' ? `
                        <button class="btn" id="btn-${ex.idx}" onclick="app.toggleExTimer(${ex.idx})">
                            <i class="fa-solid fa-play"></i> &nbsp; é–‹å§‹å‹•ä½œ
                        </button>
                    ` : `
                        <button class="btn btn-outline" disabled style="border:2px solid #ccc; color:#aaa;">å·²å®Œæˆ</button>
                    `}
                </div>
            `;
        });
    },

    toggleExTimer: function(idx) {
        const btn = document.getElementById(`btn-${idx}`);
        const disp = document.getElementById(`t-${idx}`);
        const ex = this.data.currentWorkout[idx];

        if(!this.data.timers[idx]) {
            btn.className = 'btn btn-danger';
            btn.innerHTML = '<i class="fa-solid fa-stop"></i> &nbsp; å®Œæˆä¸¦åœæ­¢';
            const start = Date.now() - (ex.timer * 1000);
            this.data.timers[idx] = setInterval(() => {
                const s = Math.floor((Date.now() - start)/1000);
                ex.timer = s;
                const m = String(Math.floor(s/60)).padStart(2,'0');
                const ss = String(s%60).padStart(2,'0');
                disp.textContent = `${m}:${ss}`;
            }, 1000);
        } else {
            clearInterval(this.data.timers[idx]);
            delete this.data.timers[idx];
            ex.state = 'done';
            
            ex.load = document.getElementById(`w-${idx}`).value;
            // parse sets x reps loosely
            const sr = document.getElementById(`s-${idx}`).value; 
            ex.reps = sr.includes('x') ? sr.split('x')[1].trim() : sr;
            ex.rpe = document.getElementById(`rpe-${idx}`).value;

            document.getElementById(`card-${idx}`).classList.add('completed');
            btn.parentElement.innerHTML = `<button class="btn btn-outline" disabled style="border:2px solid #ccc; color:#aaa;">å·²å®Œæˆ</button>`;

            const duration = (ex.type === 'cardio') ? 0 : (ex.type === 'core' ? 45 : 90);
            if(duration > 0) this.startRestTimer(duration, idx + 1);
        }
    },

    startRestTimer: function(seconds, nextIdx) {
        const modal = document.getElementById('rest-modal');
        const display = document.getElementById('rest-timer-display');
        modal.classList.add('show');
        modal.style.display = 'flex';
        this.data.restTimeLeft = seconds;
        
        const update = () => {
            const m = String(Math.floor(this.data.restTimeLeft/60)).padStart(2,'0');
            const s = String(this.data.restTimeLeft%60).padStart(2,'0');
            display.textContent = `${m}:${s}`;
        };
        update();

        this.data.restInterval = setInterval(() => {
            this.data.restTimeLeft--;
            update();
            if(this.data.restTimeLeft <= 0) {
                this.skipRest();
                playBeep();
                const nextCard = document.getElementById(`card-${nextIdx}`);
                if(nextCard) setTimeout(() => nextCard.scrollIntoView({behavior: 'smooth', block: 'center'}), 300);
            }
        }, 1000);
    },

    addRestTime: function(s) { this.data.restTimeLeft += s; },
    skipRest: function() {
        clearInterval(this.data.restInterval);
        this.closeModal('rest-modal');
    },

    showInstruction: function(id) {
        const ex = EXERCISE_DB[id];
        if(!ex) return;
        document.getElementById('inst-title').innerText = ex.name;
        document.getElementById('inst-content').innerHTML = `
            <h4 style="margin:10px 0;">âœ… å‹•ä½œæ­¥é©Ÿ</h4>
            <ul class="step-list">${ex.steps.map(s=>`<li>${s}</li>`).join('')}</ul>
            <h4 style="margin:10px 0; color:var(--danger)">âŒ å¸¸è¦‹éŒ¯èª¤</h4>
            <ul class="mistake-list">${ex.mistakes.map(s=>`<li>${s}</li>`).join('')}</ul>
        `;
        const m = document.getElementById('instruction-modal');
        m.style.display = 'flex';
        setTimeout(() => m.classList.add('show'), 10);
    },
    
    closeModal: function(id) {
        const m = document.getElementById(id);
        m.classList.remove('show');
        setTimeout(() => m.style.display = 'none', 300);
    },

    finishAll: function() {
        const done = this.data.currentWorkout.filter(e => e.state === 'done');
        if(done.length === 0) return alert('è«‹è‡³å°‘å®Œæˆä¸€å€‹å‹•ä½œ');
        if(confirm('ç¢ºå®šå„²å­˜æœ¬æ¬¡è¨“ç·´ï¼Ÿ')) {
            const record = {
                date: new Date().toISOString(),
                duration: done.reduce((a,b) => a + b.timer, 0),
                avgRpe: (done.reduce((a,b) => a + Number(b.rpe), 0) / done.length).toFixed(1),
                exercises: done.map(e => ({ name: e.name, weight: e.load, reps: e.reps, rpe: e.rpe, muscle: e.muscle }))
            };
            this.data.history.push(record);
            localStorage.setItem('fp_history', JSON.stringify(this.data.history));
            this.renderHome();
            this.nav('home-page');
        }
    },

    quitWorkout: function() {
        if(confirm('æ”¾æ£„å¾Œé€²åº¦ä¸æœƒå„²å­˜ï¼Œç¢ºå®šå—ï¼Ÿ')) {
            Object.values(this.data.timers).forEach(clearInterval);
            this.nav('home-page');
        }
    },

    // --- 4. Optimized Chart UI ---
    renderProgress: function() {
        const ctx = document.getElementById('freqChart').getContext('2d');
        if(window.myChart) window.myChart.destroy();
        
        // Calculate weeks logic (simplified)
        const weeklyCounts = [2, 3, 2, this.data.history.length % 5]; // Dummy data for demo + real count mixed

        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['W-3', 'W-2', 'W-1', 'æœ¬é€±'],
                datasets: [{
                    label: 'æ¬¡æ•¸',
                    data: weeklyCounts,
                    backgroundColor: '#2563eb',
                    borderRadius: 8,
                    barPercentage: 0.6
                }]
            },
            options: { 
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: {display:false} }, 
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        max: 7, // Fixed max height
                        ticks: { stepSize: 1 }
                    }, 
                    x: { grid: {display: false} } 
                } 
            }
        });
        
        document.getElementById('storage-usage').textContent = `å·²ç”¨ç©ºé–“: ${(JSON.stringify(localStorage).length/1024).toFixed(2)} KB`;
    },

    renderHistory: function() {
        const filter = document.getElementById('history-filter').value;
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        
        [...this.data.history].reverse().slice(0, 10).forEach(rec => {
            let exs = rec.exercises;
            if(filter !== 'all') exs = exs.filter(e => e.muscle.includes({chest:'èƒ¸',back:'èƒŒ',shoulders:'è‚©',legs:'è…¿',core:'æ ¸å¿ƒ'}[filter]));
            
            if(exs.length === 0 && filter !== 'all') return;

            list.innerHTML += `
                <div style="padding:15px 0; border-bottom:1px solid rgba(0,0,0,0.05);">
                    <div style="display:flex; justify-content:space-between; font-weight:700; margin-bottom:5px;">
                        <span>${new Date(rec.date).toLocaleDateString()}</span>
                        <span style="color:var(--primary)">${rec.avgRpe} RPE</span>
                    </div>
                    ${exs.map(e => `
                        <div style="display:flex; justify-content:space-between; font-size:0.9rem; color:var(--text-sub); margin-top:4px;">
                            <span>${e.name}</span>
                            <span>${e.weight}kg (${e.reps})</span>
                        </div>
                    `).join('')}
                </div>
            `;
        });
    },

    exportCSV: function() {
        let csv = "Date,Exercise,Weight,Reps,RPE\n";
        this.data.history.forEach(h => {
            const d = h.date.split('T')[0];
            h.exercises.forEach(e => csv += `${d},${e.name},${e.weight},${e.reps},${e.rpe}\n`);
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
        link.download = `gym_data_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    },

    resetData: function() {
        if(confirm('è­¦å‘Šï¼šæ­¤æ“ä½œä¸å¯é€†ï¼')) { localStorage.clear(); location.reload(); }
    }
};

window.onload = () => app.init();
</script>
</body>
</html>
