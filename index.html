<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥èº«è¨“ç·´åŠ©æ‰‹ (Pro)</title>
    
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuWBpemgq+aWsOaJi+i1t+eTn+aOqeaJi4iLAogICJzaG9ydF9uYW1lIjogIuWBpemgq+aWsOaJi+IqwogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMzYjgyZjYiCn0=">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* æ˜äº®è—ç™½é…è‰² */
            --bg-color: #f3f6f9;       /* æ·ºç°è—èƒŒæ™¯ï¼Œé¿å…ç´”ç™½åˆºçœ¼ */
            --card-bg: #ffffff;        /* ç´”ç™½å¡ç‰‡ */
            --primary: #2563eb;        /* äº®è—è‰² Main Blue */
            --primary-light: #eff6ff;  /* æ¥µæ·ºè— (èƒŒæ™¯é»ç¶´) */
            --text-main: #1f2937;      /* æ·±ç°é»‘ */
            --text-sub: #6b7280;       /* æ·ºç° */
            --accent: #3b82f6;         /* è¼”åŠ©è— */
            --danger: #ef4444;
            --nav-height: 65px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
            padding-bottom: calc(var(--nav-height) + 20px);
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background-color: var(--bg-color);
        }

        /* æ–‡å­—æ’ç‰ˆ */
        h1, h2, h3 { margin: 0 0 10px 0; font-weight: 700; color: #111827; }
        p { margin: 0 0 10px 0; color: var(--text-sub); line-height: 1.6; }
        
        .section {
            padding: 20px;
            display: none;
            animation: fadeIn 0.4s ease;
        }
        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* å¡ç‰‡æ¨£å¼ (æ”¹ç‚ºç™½è‰²åœ“è§’ + é™°å½±) */
        .card {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.03);
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            background-color: var(--primary);
            color: #ffffff;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            transition: transform 0.1s, background-color 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn:hover { background-color: #1d4ed8; }
        .btn-outline { 
            background: transparent; 
            border: 2px solid var(--primary); 
            color: var(--primary); 
            box-shadow: none;
        }
        .btn-danger { background-color: var(--danger); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }

        /* è¡¨å–®å…ƒç´  */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #374151; font-weight: 500; font-size: 0.95rem; }
        input, select {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background-color: #f9fafb;
            color: #111827;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); background: #fff; }

        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            background: #f3f4f6;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        .checkbox-item:hover { background: #e5e7eb; }
        .checkbox-item input { width: auto; margin-right: 10px; }

        /* å°èˆªåˆ— */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background-color: #ffffff;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #e5e7eb;
            z-index: 100;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.03);
        }
        
        .nav-item {
            color: #9ca3af;
            text-align: center;
            font-size: 0.75rem;
            cursor: pointer;
            flex: 1;
            padding: 10px 0;
            transition: color 0.2s;
        }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; display: block; }
        .nav-item.active { color: var(--primary); }

        /* è¨“ç·´é é¢æ¨£å¼ */
        .tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            background: var(--primary-light);
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 5px;
        }

        .exercise-media {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .media-box {
            flex: 1;
            background: #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            aspect-ratio: 16/10;
        }
        .media-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .media-label {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.6);
            color: white;
            font-size: 0.7rem;
            padding: 4px;
            text-align: center;
        }

        .tips { 
            background: #fffbeb; 
            color: #92400e; 
            padding: 12px; 
            border-radius: 8px; 
            font-size: 0.9rem; 
            margin: 10px 0; 
            border-left: 4px solid #f59e0b; 
        }

        .input-row { display: flex; gap: 10px; margin-top: 15px; }
        .input-group { flex: 1; }
        .input-group span { font-size: 0.8rem; color: var(--text-sub); display: block; margin-bottom: 4px;}

        /* é€²åº¦æ¢ */
        .progress-bar-bg { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; margin-top: 5px; }
        .progress-bar-fill { height: 100%; background: var(--primary); border-radius: 4px; width: 0%; transition: width 0.5s ease; }

        /* Onboarding è¦†è“‹ */
        #onboarding-page { z-index: 200; background: var(--bg-color); min-height: 100vh; position: absolute; top: 0; width: 100%; padding-bottom: 50px;}

    </style>
</head>
<body>

<div class="app-container">

    <div id="onboarding-page" class="section">
        <h1 style="color: var(--primary); margin-top: 20px;">æ‰“é€ ä½ çš„å°ˆå±¬èœå–®</h1>
        <p>è«‹è©³ç´°å¡«å¯«ï¼Œè®“æˆ‘å€‘ç‚ºæ‚¨è¨ˆç®—æœ€ä½³è¨“ç·´é‡ã€‚</p>
        
        <div class="card">
            <h3>èº«é«”æ•¸æ“š</h3>
            <div class="form-group">
                <label>å§“å / æš±ç¨±</label>
                <input type="text" id="ob-name" placeholder="ä¾‹å¦‚ï¼šAlex">
            </div>
            <div class="checkbox-grid">
                <div class="form-group">
                    <label>èº«é«˜ (cm)</label>
                    <input type="number" id="ob-height" placeholder="175">
                </div>
                <div class="form-group">
                    <label>é«”é‡ (kg)</label>
                    <input type="number" id="ob-weight" placeholder="70">
                </div>
            </div>
            <div class="checkbox-grid">
                <div class="form-group">
                    <label>é«”è„‚ç‡ (%) <small>(é¸å¡«)</small></label>
                    <input type="number" id="ob-fat" placeholder="20">
                </div>
                <div class="form-group">
                    <label>åŸºç¤ä»£è¬ (BMR) <small>(é¸å¡«)</small></label>
                    <input type="number" id="ob-bmr" placeholder="1600">
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ç›®æ¨™è¨­å®š</h3>
            <div class="form-group">
                <label>ä¸»è¦ç›®æ¨™</label>
                <select id="ob-goal">
                    <option value="fat_loss">æ¸›è„‚ (Fat Loss)</option>
                    <option value="muscle">å¢è‚Œ (Muscle Build)</option>
                    <option value="strength">åŠ›é‡æå‡ (Strength)</option>
                </select>
            </div>
            <div class="form-group">
                <label>å…·é«”ç›®æ¨™æè¿°</label>
                <input type="text" id="ob-target-desc" placeholder="ä¾‹å¦‚ï¼šæ¸›æ‰5å…¬æ–¤ã€æ·±è¹²100å…¬æ–¤...">
            </div>
            <div class="form-group">
                <label>é è¨ˆé”æˆæ™‚é–“</label>
                <select id="ob-weeks">
                    <option value="4">4 é€± (çŸ­æœŸè¡åˆº - å¼·åº¦é«˜)</option>
                    <option value="8">8 é€± (æ¨™æº–é€±æœŸ)</option>
                    <option value="12" selected>12 é€± (ç©©å¥æ”¹è®Š)</option>
                    <option value="24">24 é€±ä»¥ä¸Š (é•·æœŸç¿’æ…£)</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ¯é€±è¨“ç·´å¤©æ•¸</label>
                <select id="ob-freq">
                    <option value="2">2 å¤©</option>
                    <option value="3" selected>3 å¤©</option>
                    <option value="4">4 å¤©</option>
                    <option value="5">5 å¤©</option>
                </select>
            </div>
        </div>

        <div class="card">
            <h3>å¯ç”¨å™¨æ (è«‹å‹¾é¸)</h3>
            <div class="checkbox-grid" id="ob-equipment">
                </div>
        </div>

        <button class="btn" onclick="app.completeOnboarding()">ç”Ÿæˆæˆ‘çš„è¨ˆç•«</button>
    </div>

    <div id="home-page" class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h2 id="home-greeting" style="color: var(--primary);">Hi, ...</h2>
                <p id="home-stats" style="font-size: 0.9rem;">BMI: -- | TDEE: --</p>
            </div>
            <div style="text-align: right;">
                <span class="tag" id="target-tag">ç›®æ¨™: å¢è‚Œ</span>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <h3>æœ¬é€±ç›®æ¨™</h3>
                <span id="week-progress-text" style="color:var(--primary); font-weight:bold;">0/3</span>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="home-progress-bar"></div>
            </div>
            <p style="margin-top:10px; font-size:0.85rem;">ä¿æŒè¦å¾‹æ˜¯é—œéµï¼</p>
        </div>

        <div class="card" style="text-align: center; padding: 40px 20px; border: 2px dashed var(--primary); background: var(--primary-light);">
            <i class="fa-solid fa-fire fa-3x" style="color: var(--primary); margin-bottom: 15px;"></i>
            <h3>ä»Šæ—¥è¨“ç·´æº–å‚™å°±ç·’</h3>
            <p id="daily-suggestion">æ ¹æ“šä½ çš„æ™‚é–“è¡¨ï¼Œä»Šå¤©é©åˆé€²è¡Œ...</p>
            <button class="btn" onclick="app.generateAndStartWorkout()">ç”Ÿæˆä»Šæ—¥èœå–®</button>
        </div>

        <div class="card">
            <h3><i class="fa-solid fa-clock-rotate-left"></i> è¿‘æœŸæ‘˜è¦</h3>
            <div id="last-week-summary">
                <p>å°šç„¡è¨“ç·´ç´€éŒ„ã€‚</p>
            </div>
        </div>
    </div>

    <div id="workout-page" class="section">
        <h2 id="workout-title">ä»Šæ—¥è¨“ç·´</h2>
        <p id="workout-focus">...</p>

        <div id="workout-list"></div>

        <button class="btn" onclick="app.finishWorkout()">å®Œæˆè¨“ç·´ä¸¦å„²å­˜</button>
        <button class="btn btn-outline" onclick="app.navigate('home-page')" style="margin-top: 15px;">å–æ¶ˆ / è¿”å›</button>
    </div>

    <div id="progress-page" class="section">
        <h2>æ•¸æ“šè¿½è¹¤</h2>
        
        <div class="card">
            <h3>è¨“ç·´é »ç‡è¶¨å‹¢</h3>
            <canvas id="progressChart"></canvas>
        </div>

        <div class="card">
            <h3>èº«é«”æ•¸æ“šè®ŠåŒ–</h3>
            <p>èµ·å§‹é«”é‡: <span id="start-weight">--</span> kg</p>
            <p>ç›®å‰ç›®æ¨™: <span id="current-goal-desc">--</span></p>
            <p>å‰©é¤˜æ™‚é–“: <span id="time-left">--</span> é€±</p>
        </div>

        <div class="card">
            <h3>AI æ•™ç·´å»ºè­°</h3>
            <p id="ai-advice">é»æ“ŠæŒ‰éˆ•ç²å–å»ºè­°...</p>
            <button class="btn btn-outline" onclick="app.generateAdvice()">åˆ†æä¸‹é€±å»ºè­°</button>
        </div>
    </div>

    <div class="nav-bar" id="main-nav" style="display: none;">
        <div class="nav-item active" onclick="app.navigate('home-page')">
            <i class="fa-solid fa-house"></i> é¦–é 
        </div>
        <div class="nav-item" onclick="app.navigate('progress-page')">
            <i class="fa-solid fa-chart-pie"></i> æ•¸æ“š
        </div>
        <div class="nav-item" onclick="app.resetData()" style="color: var(--danger)">
            <i class="fa-solid fa-user-gear"></i> é‡è¨­
        </div>
    </div>

</div>

<script>
/**
 * å¥èº«åŠ©æ‰‹ Pro - æ ¸å¿ƒé‚è¼¯
 */

// 1. è³‡æ–™åº« (å«åœ–ç‰‡ Placeholder é€£çµ)
// ä½¿ç”¨ placehold.co ç”Ÿæˆå¸¶æœ‰æ–‡å­—çš„åœ–ç‰‡ï¼Œæ¨¡æ“¬ GIF å’Œè‚Œç¾¤åœ–
const EQUIPMENTS = [
    { id: 'treadmill', name: 'è·‘æ­¥æ©Ÿ' },
    { id: 'dumbbell', name: 'å•éˆ´' },
    { id: 'chest_press', name: 'åå§¿èƒ¸æ¨æ©Ÿ' },
    { id: 'shoulder_press', name: 'åå§¿è‚©æ¨æ©Ÿ' },
    { id: 'lat_pulldown', name: 'æ»‘è¼ªä¸‹æ‹‰æ©Ÿ' },
    { id: 'rowing_machine', name: 'åå§¿åˆ’èˆ¹æ©Ÿ' },
    { id: 'leg_curl', name: 'è…¿å½èˆ‰æ©Ÿ' },
    { id: 'leg_press', name: 'è…¿æ¨æ©Ÿ' },
    { id: 'pec_fly', name: 'è´è¶æ©Ÿ' },
    { id: 'roman_chair', name: 'ç¾…é¦¬æ¤…' },
    { id: 'mat', name: 'ç‘œçˆå¢Š(å¾’æ‰‹)' }
];

// Helper: ç”¢ç”Ÿåœ–ç‰‡ URL (å¯¦å‹™ä¸Šè«‹æ›æˆçœŸå¯¦è·¯å¾‘)
const getGifUrl = (text) => `https://placehold.co/600x400/e0f2fe/1e40af?text=${encodeURIComponent(text + '\n(GIF)')}`;
const getMuscleUrl = (text) => `https://placehold.co/600x400/ffe4e6/be123c?text=${encodeURIComponent(text + '\n(è‚Œç¾¤)')}`;

const EXERCISE_DB = {
    warmup: [
        { name: 'è·‘æ­¥æ©Ÿå¿«èµ°', equip: 'treadmill', type: 'cardio', gif: 'è·‘æ­¥æ©Ÿæ¼”ç¤º', muscle: 'å…¨èº«å¿ƒè‚º', tips: 'é€Ÿåº¦ 5-6ï¼Œé›™æ‰‹æ“ºå‹•ã€‚' },
        { name: 'é–‹åˆè·³', equip: 'mat', type: 'cardio', gif: 'é–‹åˆè·³æ¼”ç¤º', muscle: 'å…¨èº«/å°è…¿', tips: 'è½åœ°è¼•ç›ˆï¼Œä¿æŒå‘¼å¸ã€‚' }
    ],
    chest: [
        { name: 'åå§¿èƒ¸æ¨', equip: 'chest_press', type: 'push', gif: 'èƒ¸æ¨æ©Ÿæ¼”ç¤º', muscle: 'èƒ¸å¤§è‚Œ/ä¸‰é ­', tips: 'æŒºèƒ¸ï¼Œè‚©èƒ›éª¨æ”¶ç·Šï¼Œæ¨æ™‚åæ°£ã€‚' },
        { name: 'å•éˆ´è‡¥æ¨', equip: 'dumbbell', type: 'push', gif: 'å•éˆ´è‡¥æ¨æ¼”ç¤º', muscle: 'èƒ¸å¤§è‚Œ', tips: 'æ‰‹è…•ä¸­ç«‹ï¼Œä¸‹æ”¾è‡³èƒ¸ç·šã€‚' },
        { name: 'è´è¶æ©Ÿå¤¾èƒ¸', equip: 'pec_fly', type: 'push', gif: 'å¤¾èƒ¸æ¼”ç¤º', muscle: 'èƒ¸ä¸­ç¸«', tips: 'åƒæŠ±æ¨¹ä¸€æ¨£ç’°æŠ±ï¼Œæ‰‹è‚˜å¾®å½ã€‚' }
    ],
    back: [
        { name: 'æ»‘è¼ªä¸‹æ‹‰', equip: 'lat_pulldown', type: 'pull', gif: 'ä¸‹æ‹‰æ¼”ç¤º', muscle: 'èƒŒé—Šè‚Œ', tips: 'é–éª¨æ–¹å‘æ‹‰ï¼Œæ‰‹è‚˜å¾€ä¸‹å¸¶ã€‚' },
        { name: 'åå§¿åˆ’èˆ¹', equip: 'rowing_machine', type: 'pull', gif: 'åˆ’èˆ¹æ¼”ç¤º', muscle: 'è±å½¢è‚Œ/èƒŒåšåº¦', tips: 'æŒºèƒ¸ï¼Œæ‹‰å‘è‚šè‡ï¼Œå¤¾ç·ŠèƒŒéƒ¨ã€‚' },
        { name: 'å•éˆ´å–®è‡‚åˆ’èˆ¹', equip: 'dumbbell', type: 'pull', gif: 'å–®è‡‚åˆ’èˆ¹æ¼”ç¤º', muscle: 'èƒŒé—Šè‚Œ', tips: 'èƒŒæ‰“ç›´ï¼Œå°‡å•éˆ´æ‹‰è‡³è…°å´ã€‚' }
    ],
    shoulder: [
        { name: 'åå§¿è‚©æ¨', equip: 'shoulder_press', type: 'push', gif: 'è‚©æ¨æ©Ÿæ¼”ç¤º', muscle: 'å‰ä¸‰è§’è‚Œ', tips: 'æ ¸å¿ƒæ”¶ç·Šï¼Œæ¨è‡³é ­é ‚ä¸Šæ–¹ã€‚' },
        { name: 'å•éˆ´å´å¹³èˆ‰', equip: 'dumbbell', type: 'push', gif: 'å´å¹³èˆ‰æ¼”ç¤º', muscle: 'ä¸­ä¸‰è§’è‚Œ', tips: 'æ‰‹è‚˜å¾®å½ï¼Œèˆ‰è‡³è‚©é«˜ã€‚' }
    ],
    legs: [
        { name: 'å•éˆ´æ·±è¹²', equip: 'dumbbell', type: 'legs', gif: 'æ·±è¹²æ¼”ç¤º', muscle: 'è‚¡å››é ­/è‡€å¤§è‚Œ', tips: 'å±è‚¡å¾Œåï¼Œè†è“‹å°æº–è…³å°–ã€‚' },
        { name: 'è…¿æ¨èˆ‰', equip: 'leg_press', type: 'legs', gif: 'è…¿æ¨æ©Ÿæ¼”ç¤º', muscle: 'è‚¡å››é ­è‚Œ', tips: 'è…³æ¿æ”¾ç©©ï¼Œè†è“‹ä¸é–æ­»ã€‚' },
        { name: 'å¾’æ‰‹æ·±è¹²', equip: 'mat', type: 'legs', gif: 'å¾’æ‰‹æ·±è¹²æ¼”ç¤º', muscle: 'è…¿éƒ¨è‚Œç¾¤', tips: 'èƒŒéƒ¨æŒºç›´ï¼Œé‡å¿ƒåœ¨è…³è·Ÿã€‚' }
    ],
    core: [
        { name: 'ç¾…é¦¬æ¤…èƒŒä¼¸', equip: 'roman_chair', type: 'core', gif: 'èƒŒä¼¸æ¼”ç¤º', muscle: 'è±è„Šè‚Œ/ä¸‹èƒŒ', tips: 'èƒŒæ‰“ç›´ä¸‹ï¼Œå¤¾è‡€ä¸Šã€‚' },
        { name: 'å¹³æ¿æ”¯æ’', equip: 'mat', type: 'core', gif: 'å¹³æ¿æ’æ¼”ç¤º', muscle: 'è…¹æ©«è‚Œ', tips: 'èº«é«”å‘ˆç›´ç·šï¼Œæ”¶ç·Šè…¹éƒ¨ã€‚' }
    ]
};

const app = {
    data: {
        profile: null,
        history: [],
        currentWorkout: null
    },

    init: function() {
        const storedProfile = localStorage.getItem('gym_pro_profile');
        const storedHistory = localStorage.getItem('gym_pro_history');

        if (storedHistory) this.data.history = JSON.parse(storedHistory);

        // æ¸²æŸ“ Onboarding çš„å™¨æ
        const equipContainer = document.getElementById('ob-equipment');
        equipContainer.innerHTML = EQUIPMENTS.map(eq => `
            <label class="checkbox-item">
                <input type="checkbox" value="${eq.id}" checked>
                ${eq.name}
            </label>
        `).join('');

        if (!storedProfile) {
            this.navigate('onboarding-page');
        } else {
            this.data.profile = JSON.parse(storedProfile);
            document.getElementById('main-nav').style.display = 'flex';
            this.renderHome();
            this.navigate('home-page');
        }
    },

    navigate: function(pageId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        window.scrollTo(0, 0);
        
        // Update Nav
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(pageId === 'home-page') document.querySelectorAll('.nav-item')[0].classList.add('active');
        if(pageId === 'progress-page') {
            document.querySelectorAll('.nav-item')[1].classList.add('active');
            this.renderProgress();
        }
    },

    completeOnboarding: function() {
        // æ”¶é›†è©³ç´°æ•¸æ“š
        const p = {
            name: document.getElementById('ob-name').value || 'å¥å‹',
            height: Number(document.getElementById('ob-height').value) || 170,
            weight: Number(document.getElementById('ob-weight').value) || 65,
            fat: document.getElementById('ob-fat').value,
            bmr: document.getElementById('ob-bmr').value,
            goal: document.getElementById('ob-goal').value,
            goalDesc: document.getElementById('ob-target-desc').value || 'æ›´å¥åº·',
            weeks: Number(document.getElementById('ob-weeks').value),
            freq: Number(document.getElementById('ob-freq').value),
            equipment: Array.from(document.querySelectorAll('#ob-equipment input:checked')).map(cb => cb.value)
        };
        p.equipment.push('mat'); // æ°¸é æœ‰å¾’æ‰‹

        // è¨ˆç®— BMI
        p.bmi = (p.weight / ((p.height/100) ** 2)).toFixed(1);
        
        // ä¼°ç®— BMR (è‹¥æœªå¡«) - Mifflin-St Jeor å…¬å¼ç°¡åŒ–ç‰ˆ
        if(!p.bmr) {
            p.bmr = Math.round(10 * p.weight + 6.25 * p.height - 5 * 25 + 5); // é è¨­ç”·æ€§å…¬å¼åƒæ•¸ç°¡åŒ–
        }

        this.data.profile = p;
        localStorage.setItem('gym_pro_profile', JSON.stringify(p));
        
        document.getElementById('main-nav').style.display = 'flex';
        this.renderHome();
        this.navigate('home-page');
    },

    renderHome: function() {
        const { name, bmi, bmr, goal, freq, weeks } = this.data.profile;
        
        // Header Info
        document.getElementById('home-greeting').textContent = `Hi, ${name}`;
        
        // è¨ˆç®— TDEE (ç²—ä¼°æ´»å‹•é‡ 1.35)
        const tdee = Math.round(bmr * 1.35);
        document.getElementById('home-stats').textContent = `BMI: ${bmi} | BMR: ${bmr} kcal | TDEE: ~${tdee} kcal`;
        
        // Goal Tag translation
        const goalMap = { 'fat_loss': 'æ¸›è„‚', 'muscle': 'å¢è‚Œ', 'strength': 'åŠ›é‡' };
        document.getElementById('target-tag').textContent = `ç›®æ¨™: ${goalMap[goal]}`;

        // Progress Bar
        const now = new Date();
        const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
        startOfWeek.setHours(0,0,0,0);
        const thisWeekCount = this.data.history.filter(h => new Date(h.date) >= startOfWeek).length;
        
        document.getElementById('week-progress-text').textContent = `${thisWeekCount}/${freq}`;
        const pct = Math.min((thisWeekCount / freq) * 100, 100);
        document.getElementById('home-progress-bar').style.width = `${pct}%`;

        // Daily Suggestion Text
        const urgency = weeks < 8 ? "é«˜å¼·åº¦è¡åˆº" : "ç©©å¥é€±æœŸ";
        document.getElementById('daily-suggestion').textContent = `è¨ˆç•«é€±æœŸï¼š${urgency}ã€‚ä¾æ“šä½ çš„å™¨æï¼Œä»Šæ—¥å»ºè­°å…¨èº«æ€§è¨“ç·´ã€‚`;

        // History Summary
        const summaryDiv = document.getElementById('last-week-summary');
        if (this.data.history.length > 0) {
            const last = this.data.history[this.data.history.length - 1];
            summaryDiv.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ä¸Šæ¬¡è¨“ç·´</span>
                    <span style="color:var(--text-sub); font-size:0.9rem;">${new Date(last.date).toLocaleDateString()}</span>
                </div>
                <p>å®Œæˆ ${last.exercises.length} å€‹å‹•ä½œï¼Œå¼·åº¦ä¿‚æ•¸ ${last.intensity || 'ä¸€èˆ¬'}</p>
            `;
        }
    },

    generateAndStartWorkout: function() {
        const { equipment, goal, weeks } = this.data.profile;
        const plan = [];

        // ä¾æ“šç›®æ¨™èˆ‡é€±æœŸè¨­å®šåƒæ•¸
        let sets = 3;
        let reps = '10-12';
        // å¦‚æœæ™‚é–“çŸ­(weeks < 8)ï¼Œå¼·åº¦å¢åŠ 
        if (weeks < 8) sets = 4;

        if (goal === 'strength') reps = '5-8';
        if (goal === 'fat_loss') reps = '15-20';

        const pick = (cat) => {
            const avail = EXERCISE_DB[cat].filter(ex => equipment.includes(ex.equip));
            return avail.length ? avail[Math.floor(Math.random() * avail.length)] : null;
        };

        // 1. Warmup
        const warmup = pick('warmup') || EXERCISE_DB.warmup[1];
        plan.push({ ...warmup, sets: 1, reps: '5-10åˆ†é˜', rest: '0' });

        // 2. Main Lifts (Push/Pull/Legs)
        ['legs', 'chest', 'back', 'shoulder'].forEach(cat => {
            const ex = pick(cat);
            if(ex) plan.push({ ...ex, sets, reps, rest: '60-90ç§’' });
        });

        // 3. Core
        const core = pick('core');
        if(core) plan.push({ ...core, sets: 3, reps: '15-20', rest: '45ç§’' });

        this.data.currentWorkout = plan;
        this.renderWorkoutPage(plan);
        this.navigate('workout-page');
    },

    renderWorkoutPage: function(plan) {
        const list = document.getElementById('workout-list');
        list.innerHTML = '';
        
        const now = new Date();
        document.getElementById('workout-focus').textContent = `${now.getMonth()+1}/${now.getDate()} å…¨èº«ç¶œåˆè¨“ç·´`;

        plan.forEach((ex, index) => {
            const isWarmup = index === 0;
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span class="tag">${isWarmup ? 'æš–èº«' : ex.type.toUpperCase()}</span>
                    <strong>${ex.name}</strong>
                </div>

                <div class="exercise-media">
                    <div class="media-box">
                        <img src="${getGifUrl(ex.gif)}" alt="${ex.name} GIF">
                        <div class="media-label"><i class="fa-solid fa-film"></i> å‹•ä½œæ¼”ç¤º</div>
                    </div>
                    <div class="media-box">
                        <img src="${getMuscleUrl(ex.muscle)}" alt="${ex.muscle}">
                        <div class="media-label"><i class="fa-solid fa-child-reaching"></i> ${ex.muscle}</div>
                    </div>
                </div>

                <div style="display:flex; justify-content:space-around; background:#f9fafb; padding:10px; border-radius:10px; margin-bottom:10px;">
                    <div style="text-align:center;">
                        <div style="color:var(--text-sub); font-size:0.8rem;">çµ„æ•¸</div>
                        <div style="font-weight:bold; color:var(--primary);">${ex.sets}</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="color:var(--text-sub); font-size:0.8rem;">æ¬¡æ•¸</div>
                        <div style="font-weight:bold; color:var(--primary);">${ex.reps}</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="color:var(--text-sub); font-size:0.8rem;">ä¼‘æ¯</div>
                        <div style="font-weight:bold; color:var(--primary);">${ex.rest}</div>
                    </div>
                </div>

                <div class="tips">ğŸ’¡ ${ex.tips}</div>
                
                ${!isWarmup ? `
                <div class="input-row">
                    <div class="input-group">
                        <span>é‡é‡ (kg)</span>
                        <input type="number" class="wo-input-weight" placeholder="--">
                    </div>
                    <div class="input-group">
                        <span>å¯¦éš›æ¬¡æ•¸</span>
                        <input type="number" class="wo-input-reps" placeholder="--">
                    </div>
                </div>
                ` : ''}
            `;
            list.appendChild(card);
        });
    },

    finishWorkout: function() {
        if(!confirm('ç¢ºå®šå®Œæˆä¸¦å„²å­˜ï¼Ÿ')) return;

        const record = {
            date: new Date().toISOString(),
            intensity: this.data.profile.weeks < 8 ? 'é«˜' : 'ä¸­',
            exercises: this.data.currentWorkout.map((ex, i) => ({
                name: ex.name,
                completed: true
            }))
        };

        this.data.history.push(record);
        localStorage.setItem('gym_pro_history', JSON.stringify(this.data.history));
        
        this.renderHome();
        this.navigate('home-page');
    },

    renderProgress: function() {
        // èº«é«”æ•¸æ“š
        const p = this.data.profile;
        document.getElementById('start-weight').textContent = p.weight;
        document.getElementById('current-goal-desc').textContent = p.goalDesc;
        document.getElementById('time-left').textContent = p.weeks;

        // Chart
        const ctx = document.getElementById('progressChart').getContext('2d');
        if(window.myChart) window.myChart.destroy();

        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['W1', 'W2', 'W3', 'W4'],
                datasets: [{
                    label: 'è¨“ç·´æ¬¡æ•¸',
                    data: [2, 3, 1, this.data.history.length % 5],
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: {display: false} },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    },

    generateAdvice: function() {
        const box = document.getElementById('ai-advice');
        const p = this.data.profile;
        let msg = "";

        if (p.goal === 'fat_loss') {
            msg = `é‡å°ã€Œ${p.goalDesc}ã€çš„ç›®æ¨™ï¼šè«‹ç¢ºä¿å¿ƒç‡é”åˆ°æœ€å¤§å¿ƒç‡çš„ 60-70%ã€‚ä½ çš„ TDEE ç´„ç‚º ${Math.round(p.bmr*1.35)}ï¼Œå»ºè­°æ¯æ—¥æ”å–æ§åˆ¶åœ¨ ${Math.round(p.bmr*1.35)-300} å¤§å¡ã€‚`;
        } else {
            msg = `é‡å°å¢è‚Œç›®æ¨™ï¼šè«‹ç¢ºä¿æ¯çµ„å‹•ä½œæ¥è¿‘åŠ›ç«­ã€‚å»ºè­°æ¯æ—¥æ”å–è›‹ç™½è³ªç´„ ${p.weight * 1.5}g - ${p.weight * 2}gã€‚`;
        }
        
        box.innerHTML = `<span style="color:var(--primary); font-weight:bold;">${msg}</span>`;
    },

    resetData: function() {
        if(confirm('é‡ç½®å°‡æ¸…é™¤æ‰€æœ‰å€‹äººè³‡æ–™èˆ‡ç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ')) {
            localStorage.clear();
            location.reload();
        }
    }
};

window.addEventListener('DOMContentLoaded', () => { app.init(); });

</script>
</body>
</html>
