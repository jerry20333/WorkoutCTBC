<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥èº«è¨“ç·´åŠ©æ‰‹ (Pro)</title>
    
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* è¦–è¦ºé¢¨æ ¼ï¼šæ˜äº®è—ç™½ */
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --primary: #2563eb;       /* ä¸»è—è‰² */
            --primary-soft: #dbeafe;  /* æŸ”å’Œè—èƒŒæ™¯ */
            --text-main: #1e293b;
            --text-sub: #64748b;
            --success: #10b981;       /* æˆåŠŸç¶  */
            --nav-height: 65px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding-bottom: calc(var(--nav-height) + 20px);
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
        }

        h1, h2, h3 { margin: 0 0 10px 0; font-weight: 700; color: #0f172a; }
        p { margin: 0 0 10px 0; color: var(--text-sub); line-height: 1.6; font-size: 0.95rem; }
        
        .section { padding: 20px; display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡ */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        /* å·²å®Œæˆçš„å‹•ä½œå¡ç‰‡æ¨£å¼ */
        .card.completed {
            background: #f1f5f9;
            border-left: 5px solid var(--success);
            opacity: 0.8;
        }

        /* æŒ‰éˆ• */
        .btn {
            display: flex; align-items: center; justify-content: center;
            width: 100%; padding: 14px; border-radius: 12px;
            background-color: var(--primary); color: #fff;
            font-weight: 600; font-size: 1rem; border: none; cursor: pointer;
            transition: background 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-stop { background-color: #ef4444; }

        /* è¡¨å–® */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; color: var(--text-sub); font-size: 0.9rem; }
        input[type="text"], select {
            width: 100%; padding: 12px; border-radius: 10px;
            border: 1px solid #cbd5e1; background: #fff;
            font-size: 1rem; appearance: none;
            /* è‡ªå®šç¾©ç®­é ­ */
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 12px auto;
        }
        .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .checkbox-item { display: flex; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .checkbox-item input { margin-right: 8px; }

        /* å°èˆªåˆ— */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--nav-height); background: #fff;
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #e2e8f0; z-index: 100;
        }
        .nav-item { color: var(--text-sub); text-align: center; font-size: 0.75rem; flex: 1; padding: 8px 0; }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }

        /* ç‰¹æ®Šå…ƒä»¶ */
        .tag {
            display: inline-block; padding: 4px 10px; border-radius: 20px;
            background: var(--primary-soft); color: var(--primary);
            font-size: 0.8rem; font-weight: 600;
        }
        
        .muscle-info {
            background-color: #f8fafc; border-radius: 8px; padding: 12px;
            margin: 10px 0; border-left: 3px solid var(--primary);
            font-size: 0.9rem;
        }

        .workout-input-row { display: flex; gap: 8px; margin-top: 15px; }
        .w-input-group { flex: 1; }
        .w-input-group label { font-size: 0.75rem; margin-bottom: 2px; }
        .w-input-group input { 
            width: 100%; padding: 8px; border: 1px solid #cbd5e1; 
            border-radius: 6px; text-align: center; font-weight: bold; color: var(--primary);
        }

        .timer-display {
            font-size: 2rem; font-weight: 800; text-align: center;
            color: var(--text-main); margin: 15px 0; font-family: monospace;
        }

        /* å½ˆçª— Modal */
        #checkin-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 300;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; width: 90%; max-width: 400px;
            padding: 25px; border-radius: 20px;
            animation: fadeIn 0.3s ease;
        }

    </style>
</head>
<body>

<div class="app-container">

    <div id="onboarding-page" class="section">
        <h1 style="color: var(--primary); margin-top: 10px;">åˆå§‹è¨­å®š</h1>
        <p>å»ºç«‹æ‚¨çš„æª”æ¡ˆï¼Œè®“æˆ‘å€‘ç”¨ AI ç‚ºæ‚¨è¦åŠƒé‡é‡ã€‚</p>
        
        <div class="card">
            <div class="form-group">
                <label>å§“å</label>
                <input type="text" id="ob-name" placeholder="æ‚¨çš„ç¨±å‘¼">
            </div>
            
            <div class="checkbox-grid">
                <div class="form-group">
                    <label>èº«é«˜ (cm)</label>
                    <select id="ob-height"></select>
                </div>
                <div class="form-group">
                    <label>é«”é‡ (kg)</label>
                    <select id="ob-weight"></select>
                </div>
            </div>
            
            <div class="checkbox-grid">
                <div class="form-group">
                    <label>é«”è„‚ç‡ (%)</label>
                    <select id="ob-fat"></select>
                </div>
                <div class="form-group">
                    <label>åŸºç¤ä»£è¬ (BMR)</label>
                    <select id="ob-bmr"></select>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ç›®æ¨™èˆ‡æ™‚é–“</h3>
            <div class="form-group">
                <label>ä¸»è¦ç›®æ¨™</label>
                <select id="ob-goal">
                    <option value="muscle">å¢è‚Œ (æå‡è‚Œè‚‰é‡)</option>
                    <option value="fat_loss">æ¸›è„‚ (é™ä½é«”è„‚)</option>
                    <option value="health">å¥åº·ç¶­æŒ</option>
                </select>
            </div>
            <div class="form-group">
                <label>é è¨ˆé”æˆæ™‚é–“</label>
                <select id="ob-time">
                    <option value="4">4 é€± (çŸ­æœŸ)</option>
                    <option value="8">8 é€± (æ¨™æº–)</option>
                    <option value="12" selected>12 é€± (å»ºè­°)</option>
                    <option value="24">24 é€± (é•·æœŸ)</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ¯é€±è¨“ç·´å¤©æ•¸</label>
                <select id="ob-freq">
                    <option value="2">2 å¤©</option>
                    <option value="3" selected>3 å¤©</option>
                    <option value="4">4 å¤©</option>
                    <option value="5">5 å¤©</option>
                </select>
            </div>
        </div>

        <div class="card">
            <h3>å¯ç”¨å™¨æ</h3>
            <div class="checkbox-grid" id="ob-equipment"></div>
        </div>

        <button class="btn" onclick="app.completeOnboarding()">å»ºç«‹æª”æ¡ˆ</button>
    </div>

    <div id="home-page" class="section">
        <div style="display: flex; justify-content: space-between; align-items: end; margin-bottom: 15px;">
            <div>
                <h2 id="home-greeting" style="color: var(--primary); margin-bottom: 5px;">Hi, User</h2>
                <div id="week-date-range" class="tag">1/12 - 1/18</div>
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom: 5px;">
                <h3 style="font-size:1rem;">æœ¬é€±ç›®æ¨™</h3>
                <span id="week-progress-text" style="color:var(--primary); font-weight:bold;">0/3</span>
            </div>
            <div style="width:100%; height:8px; background:#e2e8f0; border-radius:4px;">
                <div id="home-progress-bar" style="width:0%; height:100%; background:var(--primary); border-radius:4px; transition:width 0.5s;"></div>
            </div>
        </div>

        <div class="card" style="text-align: center; border: 2px dashed var(--primary); background: #f8fafc;">
            <i class="fa-solid fa-dumbbell fa-2x" style="color: var(--primary); margin-bottom: 10px;"></i>
            <h3>ä»Šæ—¥èœå–®</h3>
            <p id="daily-suggestion">AI å·²æ ¹æ“šæ‚¨çš„æ•¸æ“šè¨ˆç®—æœ€ä½³é‡é‡ã€‚</p>
            <button class="btn" onclick="app.generateAndStartWorkout()">é–‹å§‹ä»Šæ—¥è¨“ç·´</button>
        </div>

        <div class="card">
            <h3><i class="fa-solid fa-clock-rotate-left"></i> ä¸Šæ¬¡ç´€éŒ„</h3>
            <div id="last-workout-summary">
                <p>å°šç„¡ç´€éŒ„ã€‚</p>
            </div>
        </div>
    </div>

    <div id="workout-page" class="section">
        <h2 id="workout-title">ä»Šæ—¥è¨“ç·´</h2>
        <div id="workout-list"></div>
        <button class="btn btn-success" onclick="app.finishWorkout()" style="margin-top: 20px;">å…¨éƒ¨å®Œæˆä¸¦å„²å­˜</button>
        <button class="btn btn-outline" onclick="app.navigate('home-page')" style="margin-top: 10px;">è¿”å›é¦–é </button>
    </div>

    <div id="progress-page" class="section">
        <h2>æ•¸æ“šè¿½è¹¤</h2>
        <div class="card">
            <h3>æ¯é€±é »ç‡</h3>
            <canvas id="freqChart"></canvas>
        </div>
        <div class="card">
            <h3>èº«é«”æ•¸æ“šè®ŠåŒ–</h3>
            <p>åˆå§‹é«”é‡: <span id="stat-start-weight">--</span> kg</p>
            <p>ç›®å‰é«”é‡: <span id="stat-curr-weight">--</span> kg</p>
            <p>å‰©é¤˜æ™‚é–“: <span id="stat-weeks">--</span> é€±</p>
        </div>
    </div>

    <div class="nav-bar" id="main-nav" style="display: none;">
        <div class="nav-item active" onclick="app.navigate('home-page')">
            <i class="fa-solid fa-house"></i> é¦–é 
        </div>
        <div class="nav-item" onclick="app.navigate('progress-page')">
            <i class="fa-solid fa-chart-line"></i> æ•¸æ“š
        </div>
        <div class="nav-item" onclick="app.resetData()" style="color: var(--text-sub)">
            <i class="fa-solid fa-gear"></i> é‡ç½®
        </div>
    </div>

    <div id="checkin-modal" style="display: none;">
        <div class="modal-content">
            <h2 style="color:var(--primary)">é€±ä¸€ Check-in</h2>
            <p>æ–°çš„ä¸€é€±é–‹å§‹äº†ï¼è«‹æ›´æ–°æ‚¨çš„èº«é«”æ•¸æ“šï¼Œè®“ AI èª¿æ•´å¼·åº¦ã€‚</p>
            
            <div class="form-group">
                <label>ç›®å‰é«”é‡ (kg)</label>
                <select id="ci-weight"></select>
            </div>
            <div class="form-group">
                <label>ç›®å‰é«”è„‚ (%)</label>
                <select id="ci-fat"></select>
            </div>
            
            <button class="btn" onclick="app.submitCheckin()">æ›´æ–°ä¸¦ç¹¼çºŒ</button>
        </div>
    </div>

</div>

<script>
/**
 * å¥èº«åŠ©æ‰‹ - æ ¸å¿ƒé‚è¼¯
 */

// 1. è³‡æ–™èˆ‡å·¥å…·
const EQUIPMENTS = [
    { id: 'treadmill', name: 'è·‘æ­¥æ©Ÿ' },
    { id: 'dumbbell', name: 'å•éˆ´' },
    { id: 'chest_press', name: 'åå§¿èƒ¸æ¨æ©Ÿ' },
    { id: 'shoulder_press', name: 'åå§¿è‚©æ¨æ©Ÿ' },
    { id: 'lat_pulldown', name: 'æ»‘è¼ªä¸‹æ‹‰æ©Ÿ' },
    { id: 'rowing_machine', name: 'åå§¿åˆ’èˆ¹æ©Ÿ' },
    { id: 'leg_press', name: 'è…¿æ¨æ©Ÿ' },
    { id: 'roman_chair', name: 'ç¾…é¦¬æ¤…' },
    { id: 'mat', name: 'ç‘œçˆå¢Š(å¾’æ‰‹)' }
];

const EXERCISE_DB = {
    warmup: [
        { name: 'å¿«èµ°ç†±èº«', equip: 'treadmill', type: 'cardio', muscle: 'å…¨èº«å¿ƒè‚º / è…¿éƒ¨', tips: 'é€Ÿåº¦ 5-6ï¼Œé›™æ‰‹è‡ªç„¶æ“ºå‹•ï¼Œèº«é«”å¾®å‰å‚¾ï¼Œæå‡æ ¸å¿ƒæº«åº¦ã€‚' },
        { name: 'åŸåœ°é–‹åˆè·³', equip: 'mat', type: 'cardio', muscle: 'å°è…¿ / è‚©éƒ¨ / å¿ƒè‚º', tips: 'è½åœ°æ™‚è†è“‹å¾®å½ç·©è¡ï¼Œä¿æŒå‘¼å¸ç¯€å¥ã€‚' }
    ],
    main: [
        { name: 'åå§¿èƒ¸æ¨', equip: 'chest_press', type: 'push', factor: 0.4, muscle: 'èƒ¸å¤§è‚Œ / å‰ä¸‰è§’ / ä¸‰é ­è‚Œ', tips: 'æŒºèƒ¸ä¸è³è‚©ï¼Œè‚©èƒ›éª¨è²¼ç·Šæ¤…èƒŒï¼Œæ¨å‡ºå»æ™‚åæ°£ã€‚' },
        { name: 'å•éˆ´è‡¥æ¨', equip: 'dumbbell', type: 'push', factor: 0.3, muscle: 'èƒ¸å¤§è‚Œ / æ‰‹è‡‚', tips: 'æ‰‹è…•ä¿æŒä¸­ç«‹ï¼Œä¸‹æ”¾æ™‚æ‰‹è‚˜ç•¥ä½æ–¼è‚©è†€ã€‚' },
        { name: 'æ»‘è¼ªä¸‹æ‹‰', equip: 'lat_pulldown', type: 'pull', factor: 0.5, muscle: 'èƒŒé—Šè‚Œ / äºŒé ­è‚Œ', tips: 'å‘é–éª¨æ–¹å‘æ‹‰ï¼Œæ„Ÿè¦ºæ‰‹è‚˜å¾€ä¸‹å¸¶ï¼Œèº«é«”ä¸è¦éåº¦å¾Œä»°ã€‚' },
        { name: 'åå§¿åˆ’èˆ¹', equip: 'rowing_machine', type: 'pull', factor: 0.5, muscle: 'èƒŒéƒ¨åšåº¦ / è±å½¢è‚Œ', tips: 'æ‹‰å‘è‚šè‡ï¼Œå¤¾ç·ŠèƒŒéƒ¨ï¼Œé‚„åŸæ™‚æ”¾æ…¢é€Ÿåº¦ã€‚' },
        { name: 'åå§¿è‚©æ¨', equip: 'shoulder_press', type: 'push', factor: 0.25, muscle: 'å‰ä¸­ä¸‰è§’è‚Œ', tips: 'æ ¸å¿ƒæ”¶ç·Šï¼Œæ¨è‡³é ­é ‚ä¸Šæ–¹ï¼Œä¸è¦é–æ­»é—œç¯€ã€‚' },
        { name: 'å•éˆ´æ·±è¹²', equip: 'dumbbell', type: 'legs', factor: 0.4, muscle: 'è‚¡å››é ­è‚Œ / è‡€å¤§è‚Œ', tips: 'é›™æ‰‹æŒå•éˆ´ï¼Œå±è‚¡å‘å¾Œåï¼Œè†è“‹å°æº–è…³å°–æ–¹å‘ã€‚' },
        { name: 'è…¿æ¨èˆ‰', equip: 'leg_press', type: 'legs', factor: 1.0, muscle: 'å¤§è…¿æ•´é«” / è‡€éƒ¨', tips: 'è…³æ¿æ”¾ç©©ï¼Œæ¨èµ·æ™‚è†è“‹å¾®å½ä¸é–æ­»ï¼Œä¸‹èƒŒè²¼ç·Šæ¤…å¢Šã€‚' }
    ],
    core: [
        { name: 'å¹³æ¿æ”¯æ’', equip: 'mat', type: 'core', factor: 0, muscle: 'è…¹æ©«è‚Œ / æ ¸å¿ƒç©©å®š', tips: 'èº«é«”å‘ˆä¸€ç›´ç·šï¼Œæ”¶ç·Šè‡€éƒ¨èˆ‡è…¹éƒ¨ï¼Œä¿æŒè‡ªç„¶å‘¼å¸ã€‚' },
        { name: 'ç¾…é¦¬æ¤…èƒŒä¼¸', equip: 'roman_chair', type: 'core', factor: 0, muscle: 'è±è„Šè‚Œ / ä¸‹èƒŒ / è‡€', tips: 'èƒŒæ‰“ç›´ä¸‹å»ï¼Œä¸Šä¾†æ™‚å¤¾è‡€ï¼Œä¸è¦éåº¦å¾Œä»°ã€‚' }
    ]
};

// å·¥å…·ï¼šç”¢ç”Ÿä¸‹æ‹‰é¸å–®é¸é …
const createOptions = (start, end, step, suffix = '') => {
    let html = '';
    for(let i = start; i <= end; i += step) {
        // è§£æ±ºæµ®é»æ•¸ç²¾åº¦å•é¡Œ
        let val = Math.round(i * 10) / 10;
        html += `<option value="${val}">${val}${suffix}</option>`;
    }
    return html;
};

// 2. æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒ
const app = {
    data: {
        profile: null,
        history: [],
        currentWorkout: null,
        timers: {} // å­˜ interval ID
    },

    init: function() {
        // 1. åˆå§‹åŒ–é¸å–®
        this.initDropdowns();
        
        const storedProfile = localStorage.getItem('gym_plus_profile');
        const storedHistory = localStorage.getItem('gym_plus_history');
        if (storedHistory) this.data.history = JSON.parse(storedHistory);

        if (!storedProfile) {
            this.navigate('onboarding-page');
        } else {
            this.data.profile = JSON.parse(storedProfile);
            document.getElementById('main-nav').style.display = 'flex';
            this.checkMondayUpdate(); // æª¢æŸ¥æ˜¯å¦éœ€è¦é€±ä¸€æ›´æ–°
            this.renderHome();
            this.navigate('home-page');
        }
    },

    initDropdowns: function() {
        // èº«é«˜ 140-200, é«”é‡ 40-150, é«”è„‚ 5-50, BMR 1000-3000
        const fills = [
            { id: 'ob-height', s: 140, e: 200, st: 1 },
            { id: 'ob-weight', s: 40, e: 150, st: 0.5 },
            { id: 'ob-fat', s: 5, e: 50, st: 1 },
            { id: 'ob-bmr', s: 1000, e: 3000, st: 50 },
            { id: 'ci-weight', s: 40, e: 150, st: 0.5 }, // Check-in modal
            { id: 'ci-fat', s: 5, e: 50, st: 1 }
        ];
        fills.forEach(f => {
            const els = document.querySelectorAll(`#${f.id}`);
            els.forEach(el => el.innerHTML = createOptions(f.s, f.e, f.st));
        });

        // å™¨æ
        document.getElementById('ob-equipment').innerHTML = EQUIPMENTS.map(eq => `
            <label class="checkbox-item">
                <input type="checkbox" value="${eq.id}" checked>
                ${eq.name}
            </label>
        `).join('');
    },

    // é€±ä¸€æª¢æŸ¥é‚è¼¯
    checkMondayUpdate: function() {
        const today = new Date();
        const isMonday = today.getDay() === 1;
        const lastCheck = localStorage.getItem('gym_plus_last_checkin');
        const todayStr = today.toDateString();

        if (isMonday && lastCheck !== todayStr) {
            // å½ˆå‡º Modal
            const p = this.data.profile;
            document.getElementById('ci-weight').value = p.weight; // é é¸ç›®å‰é«”é‡
            document.getElementById('ci-fat').value = p.fat;
            document.getElementById('checkin-modal').style.display = 'flex';
        }
    },

    submitCheckin: function() {
        const newWeight = document.getElementById('ci-weight').value;
        const newFat = document.getElementById('ci-fat').value;
        
        // æ›´æ–° Profile
        this.data.profile.weight = parseFloat(newWeight);
        this.data.profile.fat = parseFloat(newFat);
        localStorage.setItem('gym_plus_profile', JSON.stringify(this.data.profile));
        
        // ç´€éŒ„æ‰“å¡æ™‚é–“
        localStorage.setItem('gym_plus_last_checkin', new Date().toDateString());
        
        document.getElementById('checkin-modal').style.display = 'none';
        this.renderHome(); // æ›´æ–°é¦–é é¡¯ç¤º
        alert('æ•¸æ“šå·²æ›´æ–°ï¼Œæœ¬é€±èœå–®å°‡ä¾æ­¤èª¿æ•´ï¼');
    },

    navigate: function(pageId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        window.scrollTo(0, 0);
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(pageId === 'home-page') document.querySelectorAll('.nav-item')[0].classList.add('active');
        if(pageId === 'progress-page') {
            document.querySelectorAll('.nav-item')[1].classList.add('active');
            this.renderProgress();
        }
    },

    completeOnboarding: function() {
        const p = {
            name: document.getElementById('ob-name').value || 'å¥å‹',
            height: parseFloat(document.getElementById('ob-height').value),
            weight: parseFloat(document.getElementById('ob-weight').value),
            fat: parseFloat(document.getElementById('ob-fat').value),
            bmr: parseFloat(document.getElementById('ob-bmr').value),
            goal: document.getElementById('ob-goal').value,
            time: parseInt(document.getElementById('ob-time').value),
            freq: parseInt(document.getElementById('ob-freq').value),
            equipment: Array.from(document.querySelectorAll('#ob-equipment input:checked')).map(cb => cb.value),
            startWeight: parseFloat(document.getElementById('ob-weight').value) // ç´€éŒ„åˆå§‹é«”é‡
        };
        p.equipment.push('mat'); // é è¨­å¾’æ‰‹

        this.data.profile = p;
        localStorage.setItem('gym_plus_profile', JSON.stringify(p));
        
        document.getElementById('main-nav').style.display = 'flex';
        this.renderHome();
        this.navigate('home-page');
    },

    renderHome: function() {
        const p = this.data.profile;
        document.getElementById('home-greeting').textContent = `Hi, ${p.name}`;
        
        // æ—¥æœŸç¯„åœ (é€±ä¸€åˆ°é€±æ—¥)
        const curr = new Date();
        const first = curr.getDate() - curr.getDay() + 1; // Monday
        const last = first + 6; // Sunday
        const firstDay = new Date(curr.setDate(first));
        const lastDay = new Date(curr.setDate(last));
        document.getElementById('week-date-range').textContent = `${firstDay.getMonth()+1}/${firstDay.getDate()} - ${lastDay.getMonth()+1}/${lastDay.getDate()}`;

        // æœ¬é€±é€²åº¦
        const startOfWeek = new Date();
        startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
        startOfWeek.setHours(0,0,0,0);
        
        const doneCount = this.data.history.filter(h => new Date(h.date) >= startOfWeek).length;
        document.getElementById('week-progress-text').textContent = `${doneCount} / ${p.freq}`;
        const pct = Math.min((doneCount / p.freq) * 100, 100);
        document.getElementById('home-progress-bar').style.width = `${pct}%`;

        // ä¸Šæ¬¡ç´€éŒ„
        const summaryDiv = document.getElementById('last-workout-summary');
        if (this.data.history.length > 0) {
            const last = this.data.history[this.data.history.length - 1];
            summaryDiv.innerHTML = `
                <div style="font-weight:bold; margin-bottom:5px;">${new Date(last.date).toLocaleDateString()}</div>
                <div style="font-size:0.9rem; color:var(--text-sub);">
                    å®Œæˆ ${last.exercises.length} å€‹å‹•ä½œï¼Œç¸½è¨ˆç´„ ${Math.round(last.duration/60) || 30} åˆ†é˜
                </div>
            `;
        }
    },

    // ç”Ÿæˆè¨“ç·´é‚è¼¯
    generateAndStartWorkout: function() {
        const { equipment, goal, weight } = this.data.profile;
        const plan = [];

        // ç°¡æ˜“ AI åƒæ•¸è¨ˆç®—
        const getParams = (ex) => {
            let sets = 3;
            let reps = 12;
            let w = 0; // å»ºè­°é‡é‡

            if (ex.type === 'cardio') {
                return { sets: 1, reps: '10åˆ†é˜', weight: 0, label: 'æ™‚é–“' };
            }
            if (ex.type === 'core') {
                return { sets: 3, reps: '20ç§’', weight: 0, label: 'æ™‚é–“' };
            }

            // é‡é‡é‚è¼¯ï¼šé«”é‡ * ä¿‚æ•¸ (ç°¡å–®æ¨¡æ“¬)
            if (ex.factor) {
                w = Math.round(weight * ex.factor);
                if (goal === 'muscle') { reps = 10; w = Math.round(w * 1.1); } // å¢è‚Œé‡ä¸€é»
                if (goal === 'fat_loss') { reps = 15; w = Math.round(w * 0.8); } // æ¸›è„‚è¼•ä¸€é»
            }

            return { sets, reps, weight: w, label: 'æ¬¡æ•¸' };
        };

        const pick = (list) => {
            const avail = list.filter(e => equipment.includes(e.equip));
            return avail.length ? avail[Math.floor(Math.random() * avail.length)] : null;
        };

        // 1. Warmup
        const wm = pick(EXERCISE_DB.warmup);
        if(wm) plan.push({ ...wm, ...getParams(wm), id: 0 });

        // 2. Main (3-4 moves)
        const mainMoves = EXERCISE_DB.main.filter(e => equipment.includes(e.equip));
        // Shuffle
        mainMoves.sort(() => Math.random() - 0.5);
        mainMoves.slice(0, 4).forEach((m, idx) => {
            plan.push({ ...m, ...getParams(m), id: idx + 1 });
        });

        // 3. Core
        const core = pick(EXERCISE_DB.core);
        if(core) plan.push({ ...core, ...getParams(core), id: 99 });

        this.data.currentWorkout = plan.map(p => ({...p, timer: 0, completed: false}));
        this.renderWorkoutPage();
        this.navigate('workout-page');
    },

    renderWorkoutPage: function() {
        const list = document.getElementById('workout-list');
        list.innerHTML = '';
        
        this.data.currentWorkout.forEach((ex, idx) => {
            const card = document.createElement('div');
            card.className = `card ${ex.completed ? 'completed' : ''}`;
            card.id = `card-${idx}`;
            
            // AI å»ºè­°å€¼é¡¯ç¤º
            const suggText = ex.weight > 0 ? `AI å»ºè­°: ${ex.weight}kg x ${ex.reps}` : `ç›®æ¨™: ${ex.reps}`;

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <span class="tag">${ex.type === 'cardio' ? 'æš–èº«' : 'è¨“ç·´'}</span>
                        <h3 style="margin-top:5px;">${ex.name}</h3>
                    </div>
                </div>

                <div class="muscle-info">
                    <strong>ğŸ¯ ${ex.muscle}</strong><br>
                    <span style="color:#666; font-size:0.85rem;">${ex.tips}</span>
                </div>

                <div class="workout-input-row">
                    <div class="w-input-group">
                        <label>é‡é‡ (kg)</label>
                        <input type="number" id="in-w-${idx}" value="${ex.weight || ''}" placeholder="0">
                    </div>
                    <div class="w-input-group">
                        <label>çµ„æ•¸</label>
                        <input type="number" id="in-s-${idx}" value="${ex.sets}" placeholder="3">
                    </div>
                    <div class="w-input-group" style="flex:2; display:flex; align-items:center; justify-content:flex-end;">
                        <span style="font-size:0.8rem; color:var(--primary);">${suggText}</span>
                    </div>
                </div>

                <div class="timer-display" id="timer-${idx}">00:00</div>

                ${!ex.completed ? `
                    <button class="btn" id="btn-${idx}" onclick="app.toggleTimer(${idx})">
                        <i class="fa-solid fa-play" style="margin-right:8px;"></i> é–‹å§‹å‹•ä½œ
                    </button>
                ` : `
                    <button class="btn btn-outline" disabled>
                        <i class="fa-solid fa-check" style="margin-right:8px;"></i> å·²å®Œæˆ
                    </button>
                `}
            `;
            list.appendChild(card);
        });
    },

    toggleTimer: function(idx) {
        const btn = document.getElementById(`btn-${idx}`);
        const timerDisplay = document.getElementById(`timer-${idx}`);
        const ex = this.data.currentWorkout[idx];

        if (!this.data.timers[idx]) {
            // é–‹å§‹è¨ˆæ™‚
            btn.innerHTML = '<i class="fa-solid fa-stop"></i> å®Œæˆä¸¦åœæ­¢';
            btn.classList.add('btn-stop');
            
            const startTime = Date.now() - (ex.timer * 1000);
            
            this.data.timers[idx] = setInterval(() => {
                const sec = Math.floor((Date.now() - startTime) / 1000);
                ex.timer = sec;
                // æ ¼å¼åŒ– mm:ss
                const m = Math.floor(sec / 60).toString().padStart(2, '0');
                const s = (sec % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${m}:${s}`;
            }, 1000);

        } else {
            // åœæ­¢ä¸¦å®Œæˆ
            clearInterval(this.data.timers[idx]);
            delete this.data.timers[idx];
            
            ex.completed = true;
            
            // UI è®Šæ›´
            document.getElementById(`card-${idx}`).classList.add('completed');
            btn.className = 'btn btn-outline';
            btn.innerHTML = '<i class="fa-solid fa-check"></i> å·²å®Œæˆ';
            btn.disabled = true;

            // å­˜å…¥æ•¸æ“š (æš«å­˜æ–¼ object)
            ex.actualWeight = document.getElementById(`in-w-${idx}`).value;
            ex.actualSets = document.getElementById(`in-s-${idx}`).value;
        }
    },

    finishWorkout: function() {
        // æª¢æŸ¥æ˜¯å¦é‚„æœ‰è¨ˆæ™‚å™¨åœ¨è·‘
        if (Object.keys(this.data.timers).length > 0) {
            alert('è«‹å…ˆåœæ­¢æ‰€æœ‰å‹•ä½œçš„è¨ˆæ™‚å™¨ï¼');
            return;
        }
        
        // æª¢æŸ¥å®Œæˆåº¦
        const completedCount = this.data.currentWorkout.filter(e => e.completed).length;
        if(completedCount === 0) {
            alert('æ‚¨é‚„æ²’å®Œæˆä»»ä½•å‹•ä½œå–”ï¼');
            return;
        }

        if(!confirm(`å·²å®Œæˆ ${completedCount} å€‹å‹•ä½œï¼Œç¢ºå®šå„²å­˜å—ï¼Ÿ`)) return;

        const record = {
            date: new Date().toISOString(),
            duration: this.data.currentWorkout.reduce((acc, curr) => acc + curr.timer, 0),
            exercises: this.data.currentWorkout.filter(e => e.completed).map(e => ({
                name: e.name,
                weight: e.actualWeight,
                sets: e.actualSets,
                seconds: e.timer
            }))
        };

        this.data.history.push(record);
        localStorage.setItem('gym_plus_history', JSON.stringify(this.data.history));
        
        this.renderHome();
        this.navigate('home-page');
    },

    renderProgress: function() {
        const p = this.data.profile;
        document.getElementById('stat-start-weight').textContent = p.startWeight;
        document.getElementById('stat-curr-weight').textContent = p.weight;
        document.getElementById('stat-weeks').textContent = p.time; // é€™è£¡ç°¡å–®é¡¯ç¤ºç¸½æ™‚é•·ï¼Œå¯¦å‹™å¯ç®—å‰©é¤˜

        const ctx = document.getElementById('freqChart').getContext('2d');
        if(window.myChart) window.myChart.destroy();
        
        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['W1', 'W2', 'W3', 'W4'],
                datasets: [{
                    label: 'è¨“ç·´æ¬¡æ•¸',
                    data: [2, 3, 1, this.data.history.length % 5],
                    backgroundColor: '#2563eb',
                    borderRadius: 4
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                plugins: { legend: { display: false } }
            }
        });
    },

    resetData: function() {
        if(confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸¦é‡ä¾†ï¼Ÿ')) {
            localStorage.clear();
            location.reload();
        }
    }
};

window.addEventListener('DOMContentLoaded', () => { app.init(); });

</script>
</body>
</html>
