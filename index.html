<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥èº«æ–°æ‰‹è¨“ç·´åŠ©æ‰‹</title>
    
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuWBpemgq+aWsOaJi+i1t+eTn+aOqeaJi4iLAogICJzaG9ydF9uYW1lIjogIuWBpemgq+aWsOaJi+IqwogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzEyMTIxMiIsCiAgInRoZW1lX2NvbG9yIjogIiMxMjEyMTIiCn0=">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --primary: #4ade80; /* æ·ºç¶  */
            --primary-dark: #22c55e;
            --text-main: #ffffff;
            --text-sub: #a1a1aa;
            --danger: #ef4444;
            --nav-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
            padding-bottom: calc(var(--nav-height) + 20px); /* é¿å…è¢«åº•éƒ¨å°èˆªé®æ“‹ */
        }

        /* ä½ˆå±€å®¹å™¨ - æ‰‹æ©Ÿå„ªå…ˆï¼Œæ¡Œé¢ç½®ä¸­ */
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
        }

        /* é€šç”¨å…ƒä»¶ */
        h1, h2, h3 { margin: 0 0 10px 0; font-weight: 600; }
        p { margin: 0 0 10px 0; color: var(--text-sub); line-height: 1.5; }
        
        .section {
            padding: 20px;
            display: none; /* JS æ§åˆ¶é¡¯ç¤º */
            animation: fadeIn 0.4s ease;
        }
        
        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            background-color: var(--primary);
            color: #000;
            font-weight: bold;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn:hover { background-color: var(--primary-dark); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-danger { background-color: var(--danger); color: white; }

        /* è¡¨å–®æ¨£å¼ */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: var(--text-sub); font-size: 0.9rem; }
        input, select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            background-color: #2a2a2a;
            color: white;
            font-size: 1rem;
        }
        input:focus { outline: 2px solid var(--primary); border-color: transparent; }

        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            background: #2a2a2a;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }
        .checkbox-item input { width: auto; margin-right: 10px; }

        /* å°èˆªåˆ— */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background-color: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
        }
        
        .nav-item {
            color: var(--text-sub);
            text-align: center;
            font-size: 0.75rem;
            cursor: pointer;
            flex: 1;
            padding: 10px 0;
            transition: color 0.2s;
        }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; display: block; }
        .nav-item.active { color: var(--primary); }

        /* ç‰¹å®šé é¢æ¨£å¼ */
        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(74, 222, 128, 0.2);
            color: var(--primary);
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .exercise-card { position: relative; }
        .exercise-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .tips { background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; font-size: 0.9rem; margin: 10px 0; border-left: 3px solid var(--primary); }
        .input-row { display: flex; gap: 10px; margin-top: 10px; }
        .input-group { flex: 1; }
        .input-group span { font-size: 0.8rem; color: var(--text-sub); }

        /* Onboarding */
        #onboarding-page { z-index: 200; background: var(--bg-color); min-height: 100vh; position: absolute; top: 0; width: 100%; }

    </style>
</head>
<body>

<div class="app-container">

    <div id="onboarding-page" class="section">
        <h1 style="color: var(--primary); margin-top: 20px;">ä½ çš„å¥èº«æ–°æ‰‹æ•™ç·´</h1>
        <p>æˆ‘å€‘æœƒä¾æ“šä½ çš„å™¨æèˆ‡ç›®æ¨™ï¼Œè‡ªå‹•ç”Ÿæˆå€‹äººåŒ–è¨“ç·´è¨ˆç•«ã€‚</p>
        
        <div class="card">
            <h3>åŸºæœ¬è³‡æ–™</h3>
            <div class="form-group">
                <label>å§“å / æš±ç¨±</label>
                <input type="text" id="ob-name" placeholder="ä¾‹å¦‚ï¼šAlex">
            </div>
            <div class="form-group">
                <label>ä¸»è¦ç›®æ¨™</label>
                <select id="ob-goal">
                    <option value="fat_loss">æ¸›è„‚ (Fat Loss)</option>
                    <option value="muscle">å¢è‚Œ (Muscle Build)</option>
                    <option value="health">ä¸€èˆ¬å¥åº· (Health)</option>
                </select>
            </div>
            <div class="form-group">
                <label>æ¯é€±è¨“ç·´å¤©æ•¸ (å»ºè­° 3-4 å¤©)</label>
                <select id="ob-freq">
                    <option value="2">2 å¤©</option>
                    <option value="3" selected>3 å¤©</option>
                    <option value="4">4 å¤©</option>
                    <option value="5">5 å¤©</option>
                </select>
            </div>
        </div>

        <div class="card">
            <h3>å¯ç”¨å™¨æ (è«‹å‹¾é¸)</h3>
            <div class="checkbox-grid" id="ob-equipment">
                </div>
        </div>

        <button class="btn" onclick="app.completeOnboarding()">é–‹å§‹æˆ‘çš„è¨ˆç•«</button>
    </div>

    <div id="home-page" class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h2 id="home-greeting">Hi, ...</h2>
                <p id="home-date">...</p>
            </div>
            <div style="text-align: right;">
                <span class="tag" id="week-progress-tag">æœ¬é€±é€²åº¦: 0/3</span>
            </div>
        </div>

        <div class="card" style="text-align: center; padding: 40px 20px;">
            <i class="fa-solid fa-dumbbell fa-3x" style="color: var(--primary); margin-bottom: 20px;"></i>
            <h3>æº–å‚™å¥½è¨“ç·´äº†å—ï¼Ÿ</h3>
            <p>AI æ•™ç·´å·²æº–å‚™å¥½ä»Šå¤©çš„èœå–®</p>
            <button class="btn" onclick="app.generateAndStartWorkout()">ç”Ÿæˆä»Šæ—¥è¨“ç·´</button>
        </div>

        <div class="card">
            <h3><i class="fa-solid fa-chart-line"></i> ä¸Šé€±è¡¨ç¾</h3>
            <div id="last-week-summary">
                <p>å°šç„¡è¨“ç·´ç´€éŒ„ï¼Œå¿«é–‹å§‹ç¬¬ä¸€ç·´å§ï¼</p>
            </div>
        </div>
    </div>

    <div id="workout-page" class="section">
        <h2 id="workout-title">ä»Šæ—¥è¨“ç·´</h2>
        <p id="workout-focus">å…¨èº«è‚Œç¾¤ - ä¸­ç­‰å¼·åº¦</p>

        <div id="workout-list"></div>

        <button class="btn" onclick="app.finishWorkout()">å®Œæˆè¨“ç·´</button>
        <button class="btn btn-outline" onclick="app.navigate('home-page')" style="margin-top: 10px;">å–æ¶ˆ</button>
    </div>

    <div id="progress-page" class="section">
        <h2>é€²åº¦è¿½è¹¤</h2>
        
        <div class="card">
            <h3>æ¯é€±è¨“ç·´æ¬¡æ•¸</h3>
            <canvas id="progressChart"></canvas>
        </div>

        <div class="card">
            <h3>æœ€è¿‘ç´€éŒ„</h3>
            <ul id="history-list" style="padding-left: 20px; color: var(--text-sub);">
                </ul>
        </div>

        <div class="card">
            <h3>AI æ•™ç·´å»ºè­°</h3>
            <p id="ai-advice">é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç²å–å»ºè­°...</p>
            <button class="btn btn-outline" onclick="app.generateAdvice()">ç”Ÿæˆä¸‹é€±èª¿æ•´å»ºè­°</button>
        </div>
    </div>

    <div class="nav-bar" id="main-nav" style="display: none;">
        <div class="nav-item active" onclick="app.navigate('home-page')">
            <i class="fa-solid fa-house"></i> é¦–é 
        </div>
        <div class="nav-item" onclick="app.navigate('progress-page')">
            <i class="fa-solid fa-chart-bar"></i> é€²åº¦
        </div>
        <div class="nav-item" onclick="app.resetData()" style="color: var(--danger)">
            <i class="fa-solid fa-trash"></i> é‡ç½®
        </div>
    </div>

</div>

<script>
/**
 * å¥èº«æ–°æ‰‹è¨“ç·´åŠ©æ‰‹ - æ ¸å¿ƒé‚è¼¯
 */

// 1. è³‡æ–™åº«èˆ‡è¨­å®š
const EQUIPMENTS = [
    { id: 'treadmill', name: 'è·‘æ­¥æ©Ÿ' },
    { id: 'dumbbell', name: 'å•éˆ´' },
    { id: 'chest_press', name: 'åå§¿èƒ¸æ¨æ©Ÿ' },
    { id: 'shoulder_press', name: 'åå§¿è‚©æ¨æ©Ÿ' },
    { id: 'lat_pulldown', name: 'æ»‘è¼ªä¸‹æ‹‰æ©Ÿ' },
    { id: 'rowing_machine', name: 'åå§¿åˆ’èˆ¹æ©Ÿ' },
    { id: 'leg_curl', name: 'è…¿å½èˆ‰æ©Ÿ' },
    { id: 'pec_fly', name: 'è´è¶æ©Ÿ (å¤¾èƒ¸/åå‘)' },
    { id: 'roman_chair', name: 'ç¾…é¦¬æ¤…' },
    { id: 'ab_bench', name: 'ä»°è‡¥èµ·åæ¿' }
];

const EXERCISE_DB = {
    warmup: [
        { name: 'è·‘æ­¥æ©Ÿå¿«èµ°', equip: 'treadmill', type: 'cardio', tips: 'é€Ÿåº¦ 5-6ï¼Œé›™æ‰‹æ“ºå‹•ï¼Œèº«é«”å¾®å‰å‚¾ã€‚' },
        { name: 'åŸåœ°é–‹åˆè·³', equip: 'none', type: 'cardio', tips: 'ä¿æŒå‘¼å¸ç¯€å¥ï¼Œè½åœ°è¼•ç›ˆã€‚' }
    ],
    chest: [
        { name: 'åå§¿èƒ¸æ¨', equip: 'chest_press', type: 'push', tips: 'æŒºèƒ¸ï¼Œè‚©èƒ›éª¨æ”¶ç·Šè²¼èƒŒå¢Šï¼Œæ¨æ™‚åæ°£ã€‚éŒ¯èª¤ï¼šè³è‚©ã€‚' },
        { name: 'å•éˆ´è‡¥æ¨', equip: 'dumbbell', type: 'push', tips: 'æ‰‹è…•ä¿æŒä¸­ç«‹ï¼Œä¸‹æ”¾è‡³èƒ¸ç·šå…©å´ã€‚' },
        { name: 'è´è¶æ©Ÿå¤¾èƒ¸', equip: 'pec_fly', type: 'push', tips: 'æ‰‹è‚˜å¾®å½ï¼ŒåƒæŠ±æ¨¹ä¸€æ¨£ç’°æŠ±ã€‚' }
    ],
    back: [
        { name: 'æ»‘è¼ªä¸‹æ‹‰', equip: 'lat_pulldown', type: 'pull', tips: 'å‘é–éª¨æ–¹å‘æ‹‰ï¼Œæ„Ÿè¦ºæ‰‹è‚˜å¾€ä¸‹å¸¶ã€‚éŒ¯èª¤ï¼šèº«é«”éåº¦å¾Œä»°ã€‚' },
        { name: 'åå§¿åˆ’èˆ¹', equip: 'rowing_machine', type: 'pull', tips: 'æŒºèƒ¸ï¼Œå°‡æ‰‹æŠŠæ‹‰å‘è‚šè‡ï¼Œå¤¾ç·ŠèƒŒéƒ¨ã€‚' },
        { name: 'å•éˆ´åˆ’èˆ¹', equip: 'dumbbell', type: 'pull', tips: 'å–®æ‰‹æ”¯æ’ï¼ŒèƒŒéƒ¨æ‰“ç›´ï¼Œå°‡å•éˆ´æ‹‰è‡³è…°å´ã€‚' }
    ],
    shoulder: [
        { name: 'åå§¿è‚©æ¨', equip: 'shoulder_press', type: 'push', tips: 'æ ¸å¿ƒæ”¶ç·Šï¼Œæ¨è‡³é ­é ‚ä¸Šæ–¹ã€‚éŒ¯èª¤ï¼šè…°éƒ¨éåº¦æ‹±èµ·ã€‚' },
        { name: 'å•éˆ´å´å¹³èˆ‰', equip: 'dumbbell', type: 'push', tips: 'æ‰‹è‚˜å¾®å½ï¼Œèˆ‰è‡³èˆ‡è‚©åŒé«˜ï¼Œåƒå€’æ°´ä¸€æ¨£ã€‚' },
        { name: 'åå‘é£›é³¥', equip: 'pec_fly', type: 'pull', tips: 'é›éŠå¾Œä¸‰è§’ï¼Œæ‰‹è‡‚å¾€å¾Œå±•ï¼Œæ„Ÿå—è‚©å¾Œå´æ”¶ç¸®ã€‚' }
    ],
    legs: [
        { name: 'å•éˆ´æ·±è¹²', equip: 'dumbbell', type: 'legs', tips: 'å•éˆ´ç½®æ–¼èº«é«”å…©å´ï¼Œå±è‚¡å‘å¾Œåï¼Œè†è“‹å°æº–è…³å°–ã€‚' },
        { name: 'è…¿å½èˆ‰', equip: 'leg_curl', type: 'legs', tips: 'å‹¾è…¿æ™‚åæ°£ï¼Œæ…¢æ”¾æ™‚å¸æ°£ï¼Œå±è‚¡ä¸è¦é›¢é–‹æ¤…å¢Šã€‚' },
        { name: 'å¾’æ‰‹æ·±è¹²', equip: 'none', type: 'legs', tips: 'åŸºç¤å‹•ä½œï¼Œä¿æŒèƒŒéƒ¨æŒºç›´ã€‚' }
    ],
    core: [
        { name: 'ç¾…é¦¬æ¤…èƒŒä¼¸', equip: 'roman_chair', type: 'core', tips: 'é«–éƒ¨å°æº–è»Ÿå¢Šé‚Šç·£ï¼Œä¸‹å»æ™‚èƒŒæ‰“ç›´ï¼Œä¸Šä¾†å¤¾è‡€ã€‚' },
        { name: 'ä»°è‡¥èµ·å', equip: 'ab_bench', type: 'core', tips: 'åˆ©ç”¨è…¹éƒ¨åŠ›é‡æ²èµ·ï¼Œä¸è¦ç”¨æ‰‹æ‹‰è„–å­ã€‚' },
        { name: 'å¹³æ¿æ”¯æ’', equip: 'none', type: 'core', tips: 'èº«é«”å‘ˆä¸€ç›´ç·šï¼Œæ”¶ç·Šè‡€éƒ¨èˆ‡è…¹éƒ¨ã€‚' }
    ]
};

// 2. æ‡‰ç”¨ç¨‹å¼ç‰©ä»¶
const app = {
    data: {
        profile: null,
        history: [],
        currentWorkout: null
    },

    init: function() {
        // è®€å–è³‡æ–™
        const storedProfile = localStorage.getItem('gym_profile');
        const storedHistory = localStorage.getItem('gym_history');

        if (storedHistory) this.data.history = JSON.parse(storedHistory);

        // æ¸²æŸ“ Onboarding çš„å™¨æé¸å–®
        const equipContainer = document.getElementById('ob-equipment');
        equipContainer.innerHTML = EQUIPMENTS.map(eq => `
            <label class="checkbox-item">
                <input type="checkbox" value="${eq.id}" checked>
                ${eq.name}
            </label>
        `).join('');

        if (!storedProfile) {
            // æ–°ä½¿ç”¨è€…
            this.navigate('onboarding-page');
        } else {
            // èˆŠä½¿ç”¨è€…
            this.data.profile = JSON.parse(storedProfile);
            document.getElementById('main-nav').style.display = 'flex';
            this.renderHome();
            this.navigate('home-page');
        }
    },

    // å°èˆªæ§åˆ¶
    navigate: function(pageId) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        // æ›´æ–° Nav ç‹€æ…‹
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        if(pageId === 'home-page') document.querySelectorAll('.nav-item')[0].classList.add('active');
        if(pageId === 'progress-page') {
            document.querySelectorAll('.nav-item')[1].classList.add('active');
            this.renderProgress();
        }
    },

    // å®Œæˆ Onboarding
    completeOnboarding: function() {
        const name = document.getElementById('ob-name').value || 'å¥å‹';
        const goal = document.getElementById('ob-goal').value;
        const freq = document.getElementById('ob-freq').value;
        
        // æ”¶é›†å‹¾é¸çš„å™¨æ
        const checkedEquips = Array.from(document.querySelectorAll('#ob-equipment input:checked')).map(cb => cb.value);
        // æ°¸é åŠ å…¥ none (å¾’æ‰‹)
        checkedEquips.push('none');

        this.data.profile = { name, goal, freq, equipment: checkedEquips };
        localStorage.setItem('gym_profile', JSON.stringify(this.data.profile));
        
        document.getElementById('main-nav').style.display = 'flex';
        this.renderHome();
        this.navigate('home-page');
    },

    // æ¸²æŸ“ä¸»é 
    renderHome: function() {
        const { name, freq } = this.data.profile;
        const now = new Date();
        const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        
        // Header
        document.getElementById('home-greeting').textContent = `Hi, ${name}`;
        document.getElementById('home-date').textContent = `ä»Šå¤©æ˜¯ ${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ æ˜ŸæœŸ${weekDays[now.getDay()]}`;

        // è¨ˆç®—æœ¬é€±é€²åº¦
        const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay())); // æœ¬é€±æ—¥
        startOfWeek.setHours(0,0,0,0);
        const thisWeekCount = this.data.history.filter(h => new Date(h.date) >= startOfWeek).length;
        
        document.getElementById('week-progress-tag').textContent = `æœ¬é€±è¨“ç·´: ${thisWeekCount}/${freq}`;

        // ä¸Šé€±æ‘˜è¦ (ç°¡å–®å–æœ€è¿‘3ç­†)
        const summaryDiv = document.getElementById('last-week-summary');
        if (this.data.history.length > 0) {
            const lastWorkout = this.data.history[this.data.history.length - 1];
            summaryDiv.innerHTML = `
                <p>ä¸Šæ¬¡è¨“ç·´ï¼š${new Date(lastWorkout.date).toLocaleDateString()}</p>
                <p>å®Œæˆé …ç›®ï¼š${lastWorkout.exercises.length} å€‹å‹•ä½œ</p>
                <p style="color: var(--primary)">${thisWeekCount >= freq ? 'é€²åº¦è¶…å‰ï¼Œä¿æŒä¸‹å»ï¼' : 'é›¢é€±ç›®æ¨™é‚„æœ‰ä¸€é»è·é›¢ï¼ŒåŠ æ²¹ï¼'}</p>
            `;
        }
    },

    // AI ç”Ÿæˆè¨“ç·´é‚è¼¯
    generateAndStartWorkout: function() {
        const { equipment, goal } = this.data.profile;
        const plan = [];

        // è¼”åŠ©å‡½å¼ï¼šå¾é¡åˆ¥ä¸­éš¨æ©Ÿé¸ä¸€å€‹å¯ç”¨çš„å‹•ä½œ
        const pickExercise = (category) => {
            const available = EXERCISE_DB[category].filter(ex => equipment.includes(ex.equip));
            if (available.length === 0) return null;
            return available[Math.floor(Math.random() * available.length)];
        };

        // 1. æš–èº«
        const warmup = pickExercise('warmup') || EXERCISE_DB.warmup[1]; // fallback to jumping jacks
        plan.push({ ...warmup, sets: 1, reps: goal === 'fat_loss' ? '10åˆ†é˜' : '5åˆ†é˜', rest: 0 });

        // 2. ä¸»è¨“ç·´ (å…¨èº«æ€§ï¼šæ¨ + æ‹‰ + è…¿ + è¼”åŠ©)
        const categories = ['chest', 'back', 'legs', 'shoulder'];
        // éš¨æ©Ÿæ´—ç‰Œé †åº
        categories.sort(() => Math.random() - 0.5);

        categories.forEach(cat => {
            const ex = pickExercise(cat);
            if (ex) {
                // ä¾ç›®æ¨™è¨­å®šçµ„æ•¸æ¬¡æ•¸
                let sets = 3;
                let reps = '10-12';
                let rest = '60ç§’';

                if (goal === 'muscle') {
                    reps = '8-10';
                    rest = '90ç§’';
                } else if (goal === 'fat_loss') {
                    reps = '15-20';
                    rest = '45ç§’';
                }

                plan.push({ ...ex, sets, reps, rest });
            }
        });

        // 3. æ ¸å¿ƒ
        const core = pickExercise('core');
        if (core) {
            plan.push({ ...core, sets: 3, reps: '15-20', rest: '45ç§’' });
        }

        this.data.currentWorkout = plan;
        this.renderWorkoutPage(plan);
        this.navigate('workout-page');
    },

    // æ¸²æŸ“è¨“ç·´é é¢
    renderWorkoutPage: function(plan) {
        const list = document.getElementById('workout-list');
        list.innerHTML = '';

        plan.forEach((ex, index) => {
            const isWarmup = index === 0;
            const card = document.createElement('div');
            card.className = 'card exercise-card';
            card.innerHTML = `
                <div class="exercise-header">
                    <div>
                        <span class="tag">${isWarmup ? 'æš–èº«' : ex.type.toUpperCase()}</span>
                        <h3>${ex.name}</h3>
                        <p style="margin:0; font-size:0.9rem;">${ex.equip === 'none' ? 'å¾’æ‰‹' : EQUIPMENTS.find(e=>e.id===ex.equip)?.name || 'å™¨æ'}</p>
                    </div>
                </div>
                <div style="display:flex; gap:15px; font-weight:bold; color:var(--primary);">
                    <span><i class="fa-solid fa-layer-group"></i> ${ex.sets} çµ„</span>
                    <span><i class="fa-solid fa-rotate-right"></i> ${ex.reps}</span>
                    <span><i class="fa-solid fa-stopwatch"></i> ${ex.rest}</span>
                </div>
                <div class="tips">ğŸ’¡ ${ex.tips}</div>
                
                ${!isWarmup ? `
                <div class="input-row">
                    <div class="input-group">
                        <span>é‡é‡ (kg)</span>
                        <input type="number" class="wo-input-weight" placeholder="20">
                    </div>
                    <div class="input-group">
                        <span>æ¬¡æ•¸</span>
                        <input type="number" class="wo-input-reps" placeholder="12">
                    </div>
                    <div class="input-group">
                        <span>RPE (1-10)</span>
                        <input type="number" class="wo-input-rpe" placeholder="7">
                    </div>
                </div>
                ` : ''}
            `;
            list.appendChild(card);
        });
    },

    // å®Œæˆè¨“ç·´
    finishWorkout: function() {
        if(!confirm('ç¢ºå®šå®Œæˆè¨“ç·´ä¸¦å„²å­˜ç´€éŒ„å—ï¼Ÿ')) return;

        // æ”¶é›†æ•¸æ“š
        const inputsWeight = document.querySelectorAll('.wo-input-weight');
        const inputsReps = document.querySelectorAll('.wo-input-reps');
        const inputsRpe = document.querySelectorAll('.wo-input-rpe');
        
        const record = {
            date: new Date().toISOString(),
            exercises: this.data.currentWorkout.map((ex, i) => {
                // ç•¥éæš–èº« (index 0) çš„è©³ç´°æ•¸æ“šï¼Œæˆ–ç°¡å–®ç´€éŒ„
                if(i === 0) return { name: ex.name, completed: true };
                return {
                    name: ex.name,
                    weight: inputsWeight[i-1]?.value || 0, // -1 å› ç‚ºæš–èº«æ²’ input
                    reps: inputsReps[i-1]?.value || 0,
                    rpe: inputsRpe[i-1]?.value || 0
                };
            })
        };

        this.data.history.push(record);
        localStorage.setItem('gym_history', JSON.stringify(this.data.history));
        
        alert('å¤ªæ£’äº†ï¼è¨“ç·´å·²è¨˜éŒ„ã€‚');
        this.renderHome();
        this.navigate('home-page');
    },

    // æ¸²æŸ“é€²åº¦é 
    renderProgress: function() {
        // 1. æœ€è¿‘ç´€éŒ„æ¸…å–®
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = this.data.history.slice(-7).reverse().map(h => `
            <li style="margin-bottom:8px;">
                <strong style="color:white;">${new Date(h.date).toLocaleDateString()}</strong> 
                - å®Œæˆ ${h.exercises.length} é …å‹•ä½œ
            </li>
        `).join('') || '<p>å°šç„¡ç´€éŒ„</p>';

        // 2. Chart.js åœ–è¡¨
        const ctx = document.getElementById('progressChart').getContext('2d');
        
        // ç”¢ç”Ÿè¿‘ 4 é€±æ•¸æ“š (æ¨¡æ“¬)
        // å¯¦éš›æ‡‰éæ­· history è¨ˆç®—æ¯é€±æ¬¡æ•¸
        // é€™è£¡ç‚ºæ¼”ç¤ºç°¡åŒ–é‚è¼¯ï¼šæŠ“æœ€è¿‘ç´€éŒ„åˆ†ä½ˆ
        
        // éŠ·æ¯€èˆŠåœ–è¡¨ä»¥é¿å…é‡ç–Š
        if(window.myChart) window.myChart.destroy();

        window.myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['3é€±å‰', '2é€±å‰', 'ä¸Šé€±', 'æœ¬é€±'],
                datasets: [{
                    label: 'è¨“ç·´å¤©æ•¸',
                    data: [2, 3, 1, this.data.history.length % 5], // å‡è³‡æ–™ + å‹•æ…‹
                    backgroundColor: '#4ade80',
                    borderRadius: 4
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#aaa' } },
                    x: { grid: { display: false }, ticks: { color: '#aaa' } }
                },
                plugins: { legend: { display: false } }
            }
        });
    },

    // ç”Ÿæˆ AI å»ºè­°
    generateAdvice: function() {
        const adviceBox = document.getElementById('ai-advice');
        const count = this.data.history.length;
        
        if (count < 3) {
            adviceBox.textContent = "æ•¸æ“šä¸è¶³ã€‚è«‹è‡³å°‘å®Œæˆ 3 æ¬¡è¨“ç·´ï¼Œæˆ‘æ‰èƒ½åˆ†æä½ çš„ç‹€æ…‹å–”ï¼ç›®å‰å»ºè­°ï¼šå°ˆæ³¨æ–¼å‹•ä½œæ­£ç¢ºæ€§ï¼Œä¸è¦æ€¥è‘—åŠ é‡ã€‚";
            return;
        }

        const lastWorkouts = this.data.history.slice(-3);
        // ç°¡å–®é‚è¼¯ï¼šæª¢æŸ¥ RPE
        let avgRpe = 0;
        let validRpeCount = 0;
        
        lastWorkouts.forEach(w => {
            w.exercises.forEach(e => {
                if(e.rpe) {
                    avgRpe += parseInt(e.rpe);
                    validRpeCount++;
                }
            });
        });
        
        avgRpe = validRpeCount > 0 ? (avgRpe / validRpeCount) : 0;

        let msg = "";
        if (avgRpe > 8.5) {
            msg = "åµæ¸¬åˆ°ä½ æœ€è¿‘å¼·åº¦å¾ˆé«˜ (RPE > 8.5)ã€‚å»ºè­°ï¼šä¸‹é€±å¯ä»¥å®‰æ’ä¸€æ¬¡ã€Œæ¸›é‡è¨“ç·´ã€ï¼Œé‡é‡æ¸›è¼• 20%ï¼Œå°ˆæ³¨æ¢å¾©ã€‚";
        } else if (avgRpe < 5) {
            msg = "æœ€è¿‘è¨“ç·´å¯èƒ½æœ‰é»å¤ªè¼•é¬†å›‰ (RPE < 5)ã€‚å»ºè­°ï¼šä¸‹é€±è©¦è‘—æ¯å€‹å‹•ä½œå¢åŠ  1-2 å…¬æ–¤ï¼Œæˆ–ç¸®çŸ­ä¼‘æ¯æ™‚é–“ã€‚";
        } else {
            msg = "ä½ çš„è¨“ç·´å¼·åº¦æ§åˆ¶å¾—å¾ˆå¥½ (RPE 5-8)ã€‚å»ºè­°ï¼šä¿æŒç›®å‰çš„é »ç‡ï¼Œå¯ä»¥å˜—è©¦åœ¨æ„Ÿè¦ºæœ€å¥½çš„å‹•ä½œä¸Šå¤šåšä¸€çµ„ã€‚";
        }

        adviceBox.innerHTML = `<span style="color:var(--primary)">${msg}</span>`;
    },

    resetData: function() {
        if(confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è³‡æ–™é‡æ–°é–‹å§‹å—ï¼Ÿ')) {
            localStorage.clear();
            location.reload();
        }
    }
};

// å•Ÿå‹• App
window.addEventListener('DOMContentLoaded', () => {
    app.init();
});

</script>
</body>
</html>
